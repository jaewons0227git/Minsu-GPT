<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>MinsuGPT</title> 
  
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Elms+Sans:ital,wght@0,100..900;1,100..900;0,100..900;1,100..900&display=swap" rel="stylesheet">
  
  <link href="https://fonts.googleapis.com/icon?family=Material+Symbols+Rounded" rel="stylesheet">
  
  <style>
    :root{
      --bg: #ffffff;
      --accent:#111827; 
      --send-button-disabled: #9ca3af;
      --send-button-enabled: #111827; 
      --composer-padding: 6px 12px;
      --composer-padding-v: 12px; 
      --input-container-padding-v: 8px; 
      --font-size: 16px;
      --line-height: 1.4;
      
      --line-height-px: 22.4; 
      --min-textarea-height: 22.4px; 
      --min-input-container-height: 48px; 
      
      font-family: 'Elms Sans', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Noto Sans KR', 'Helvetica Neue', Arial, sans-serif;
    }
    
    /* Material Symbols ì•„ì´ì½˜ ìŠ¤íƒ€ì¼ */
    .material-symbols-rounded {
      font-family: 'Material Symbols Rounded';
      font-weight: normal;
      font-style: normal;
      font-size: 24px;  /* ê¸°ë³¸ í¬ê¸° */
      line-height: 1;
      letter-spacing: normal;
      text-transform: none;
      display: inline-block;
      white-space: nowrap;
      word-wrap: normal;
      direction: ltr;
      -webkit-font-feature-settings: 'liga';
      -webkit-font-smoothing: antialiased;
      
      font-variation-settings:
        'FILL' 0,
        'wght' 500,
        'GRAD' 0,
        'opsz' 24;
    }
    
    .fa, .fa-solid, .fa-regular {
        font-family: 'Material Symbols Rounded', 'Elms Sans' !important;
        font-weight: 500 !important;
        font-style: normal; 
    }
    
    *{
        box-sizing:border-box;
        -webkit-tap-highlight-color: transparent; 
    }
    body{
      margin:0;
      background:var(--bg);
      color:var(--accent);
      min-height:100vh;
      display:flex;
      justify-content:center;
      padding:0;
    }
    .phone{
      width:100%;
      background:var(--bg);
      border-radius:0;
      overflow:hidden;
      border:none;
      display:flex;
      flex-direction:column;
      min-height:100vh;
      position:relative; 
      margin: 0;
    }

    .header{
      display:flex;
      justify-content:space-between;
      align-items:center;
      padding:10px 16px;
      height:56px;
      border-bottom:none;
      
      position: sticky;
      top: 0;
      z-index: 100; 
      background: var(--bg); 
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05); 
    }
    .header-icon{
      width:32px;
      height:32px;
      display:flex;
      align-items:center;
      justify-content:center;
      color:#111827;
      cursor: pointer; 
    }
    .plus-btn{
      background-color:#f1f4ff;
      color:#1d6fef;
      font-weight:600;
      padding:6px 14px;
      border-radius:20px;
      display:flex;
      align-items:center;
      gap:4px;
      font-size:14px;
      cursor: pointer;
    }
    /* ğŸŒŸ ì•„ì´ì½˜ ì œê±°ë¡œ ì¸í•´ ê´€ë ¨ ìŠ¤íƒ€ì¼ ì œê±° */
    /* .plus-btn .material-symbols-rounded{
      font-size: 16px;
      transform:translateY(1px);
    } */
    .profile-btn{
      width:32px;
      height:32px;
      border-radius:50%;
      background-color:#e5e8eb;
      display:flex;
      align-items:center;
      justify-content:center;
      color:#111827;
    }

    .content-wrapper{
        flex-grow:1;
        display:flex;
        flex-direction:column;
        overflow-y: auto;
        padding-bottom: 0; 
        position: relative;
    }
    
    #initial-content{
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      width: 100%;
      max-width: 400px;
      display:flex;
      flex-direction:column;
      align-items:center;
      text-align:center;
      padding: 0 16px;
      transition: opacity 0.5s ease-in-out, visibility 0.5s ease-in-out;
    }
    .main-question{
      font-size:22px;
      font-weight:600;
      margin-bottom:40px;
      color:#111827;
    }
    .quick-actions{
      display:flex;
      flex-wrap:wrap;
      justify-content:center;
      gap:8px;
      max-width:400px; 
    }
    .action-btn{
      display:flex;
      align-items:center;
      justify-content:center;
      padding:10px 16px;
      border:1px solid #e5e8eb;
      border-radius:30px;
      font-size:15px;
      font-weight:500;
      color:#111827;
      min-height:48px;
      white-space:nowrap;
      cursor: pointer;
    }
    .action-btn .material-symbols-rounded, .action-btn .icon-light{
      margin-right:6px;
      width:20px;
      height:20px;
      font-size: 18px;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .action-btn.new-green .material-symbols-rounded{ color:#28a745; }
    .action-btn.new-blue .material-symbols-rounded{ color:#007bff; }
    .action-btn.orange .material-symbols-rounded{ color:#fd7e14; } 

    .chat-messages{
      width: 100%;
      padding: 10px 16px;
      display: none;
      flex-direction: column;
      justify-content: flex-start; 
      gap: 10px;
      margin: 0 auto; 
    }
    @media (min-width: 600px) {
        .chat-messages {
            max-width: 768px; 
            padding-left: 0;
            padding-right: 0;
        }
    }

    .message-bubble{
      display: flex;
      max-width: 80%;
    }
    .message-text{
      padding: 10px 14px;
      border-radius: 20px;
      line-height: 1.4;
      font-size: 15px;
      white-space: pre-wrap;
    }
    .user-message{
      justify-content: flex-end;
      align-self: flex-end;
    }
    .user-message .message-text{
      background-color: #f1f4f9; 
      color: var(--accent); 
      border-bottom-right-radius: 4px;
    }
    
    .bot-message{
      align-self: flex-start;
      margin-top: 10px;
      padding: 0; 
      color: var(--accent);
      line-height: 1.4;
      font-size: 15px;
      width: 100%; 
    }
    
    .bot-message .streaming-block {
        display: block;
        padding: 0; 
        border-radius: 0; 
        background-color: transparent; 
        max-width: 100%;
        box-sizing: border-box;
        white-space: normal;
        color: var(--accent); 
        margin-bottom: 8px; 
    }
    
    .bot-message .streaming-block {
        opacity: 1 !important; 
        transform: translateY(0) !important;
        transition: none !important; 
        color: var(--accent) !important; 
    }

    /* ë§ˆí¬ë‹¤ìš´ ìŠ¤íƒ€ì¼ë§ (ìƒëµ) */

    .bot-actions {
        display: flex;
        gap: 8px;
        margin-top: 0px; 
        padding: 4px 0;
    }

    .bot-action-btn {
        width: 32px;
        height: 32px;
        display: flex;
        align-items: center;
        justify-content: center;
        color: #9ca3af; 
        cursor: pointer;
        border-radius: 50%;
        transition: background-color 0.2s;
    }
    .bot-action-btn:hover {
        background-color: #f3f4f6;
    }
    .bot-action-btn.selected {
        color: var(--accent);
    }
    .bot-action-btn.selected.like {
        color: #1d6fef; 
    }
    .bot-action-btn.selected.dislike {
        color: #ef4444; 
    }

    .bot-action-btn .material-symbols-rounded {
        font-size: 16px;
    }
    .bot-action-btn.selected.like .material-symbols-rounded { color: #1d6fef; }
    .bot-action-btn.selected.dislike .material-symbols-rounded { color: #ef4444; }


    /* ğŸ’¡ ìƒê°í•˜ëŠ” ì¤‘... ì• ë‹ˆë©”ì´ì…˜ ìŠ¤íƒ€ì¼ (ìœ ì§€) */
    .thinking-indicator {
        display: flex;
        align-items: center;
        padding: 10px 0;
    }

    .thinking-indicator-text {
        font-weight: 500;
        margin-right: 8px;
        
        background-color: var(--accent); 
        background-image: linear-gradient(
            90deg,
            #111827 0%,
            #ffffff 20%, 
            #111827 40%
        );
        background-size: 200% 100%; 
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        animation: shimmer 1.5s infinite linear;
    }
    
    .loading-spinner {
        display: inline-block;
        width: 16px;
        height: 16px;
        border: 2px solid #ccc;
        border-top-color: #111827; 
        border-radius: 50%;
        animation: spin 0.8s linear infinite;
        margin-left: 4px;
    }
    @keyframes spin {
        to { transform: rotate(360deg); }
    }

    @keyframes shimmer {
        0% {
            background-position: 100% 0; 
        }
        100% {
            background-position: -100% 0; 
        }
    }

    /* Input area (ìœ ì§€) */
    .composer{
        position:fixed; bottom:0; left:0; right:0; width:100%; display:flex; justify-content:center; padding:var(--composer-padding); background:var(--bg); box-shadow:none; height: auto; min-height: calc(var(--min-input-container-height) + var(--composer-padding-v)); z-index: 10; 
    }
    .composer-inner{
        display:flex; align-items:center; gap:8px; width:100%;
    }
    @media (min-width: 600px) {
        .composer-inner {
            max-width: 768px; 
        }
    }

    .input-container{
      flex:1; display:flex; align-items: center; gap:8px; border-radius:24px; border:1px solid #d1d5db; padding:4px 4px 4px 16px; box-sizing:border-box; background:#ffffff; max-height: 150px; overflow: hidden; min-height: var(--min-input-container-height); 
    }
    .input-container textarea{
      flex:1; border:0; outline:0; background:transparent; color:var(--accent); font-size:var(--font-size); min-width:0; resize: none; min-height: var(--min-textarea-height); overflow-y: hidden; padding: 0; line-height: var(--line-height); vertical-align: middle; align-self: center; font-family: inherit; 
    }
    .input-container textarea::placeholder{
        color:#9ca3af;
        font-family: inherit;
    }

    .plus{
      width: var(--min-input-container-height); height: var(--min-input-container-height); border-radius:50%; background:#ffffff; border:1px solid #d1d5db; display:flex; align-items:center; justify-content:center; flex-shrink:0; align-self: center; cursor: pointer;
    }
    .plus .material-symbols-rounded {
      font-size: 20px; 
      color: #111827;
    }

    .mic-voice-container{
        display:flex; gap:8px; flex-shrink:0; margin-bottom: 0;
    }
    .mic-icon{
        width:38px; height:38px; display:flex; align-items:center; justify-content:center; flex-shrink:0; color:#9ca3af;
    }
    .mic-icon .material-symbols-rounded {
        font-size: 20px;
    }

    .send-btn, .stop-btn{
      width:38px; height:38px; border-radius:50%; display:flex; align-items:center; justify-content:center; flex-shrink:0; margin-left:0; margin-right:4px; transition: background-color 0.2s ease; cursor: pointer;
    }
    .send-btn:not(.active) {
        background-color: var(--send-button-disabled);
        pointer-events: none;
    }
    .send-btn.active {
        background-color: var(--send-button-enabled); 
        pointer-events: auto;
    }
    .send-btn .material-symbols-rounded {
        color: white;
        font-size: 18px; 
        /* ğŸŒŸ ì „ì†¡ ë²„íŠ¼ ì•„ì´ì½˜ í¬ê¸° ë³€ê²½ (í™”ì‚´í‘œì— ë§ê²Œ) */
        font-size: 20px; 
    }
    .stop-btn {
        background-color: #ef4444; 
    }
    .stop-btn .material-symbols-rounded {
        color: white;
        font-size: 16px;
    }

    /* ===================================== */
    /* ëª¨ë‹¬ ê³µí†µ ìŠ¤íƒ€ì¼ (ìœ ì§€) */
    /* ===================================== */
    .modal-backdrop {
        position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.5); opacity: 0; visibility: hidden; transition: opacity 0.3s ease, visibility 0.3s ease; z-index: 1000; display: flex; justify-content: center; align-items: flex-end;
    }
    .modal-backdrop.visible {
        opacity: 1; visibility: visible;
    }
    .modal {
        width: 100%; max-width: 768px; background-color: var(--bg); border-top-left-radius: 20px; border-top-right-radius: 20px; padding: 24px 16px 40px 16px; transform: translateY(100%); transition: transform 0.3s ease-out;
    }
    .modal-backdrop.visible .modal {
        transform: translateY(0);
    }
    .modal-handle {
        width: 40px; height: 5px; background-color: #e5e8eb; border-radius: 5px; margin: 0 auto 20px auto;
    }
    .modal-grid {
        display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; margin-bottom: 24px;
    }
    .modal-grid-item {
        display: flex; flex-direction: column; align-items: center; text-align: center; padding: 12px 0; background-color: #f1f4f9; border-radius: 12px; font-size: 14px; font-weight: 500; cursor: pointer;
    }
    .modal-grid-icon {
        width: 48px; height: 48px; background-color: #e5e8eb; border-radius: 12px; margin-bottom: 8px; display: flex; align-items: center; justify-content: center;
    }
    .modal-grid-icon .material-symbols-rounded {
        font-size: 24px;
        color: #111827;
    }

    .modal-option {
        display: flex; align-items: center; padding: 12px 10px; font-size: 16px; font-weight: 500; cursor: pointer; border-radius: 8px; transition: background-color 0.1s ease;
    }
    .modal-option:hover {
        background-color: #f1f4f9;
    }
    .modal-option-icon {
        margin-right: 12px; width: 28px; height: 28px; display: flex; align-items: center; justify-content: center;
    }
    .modal-option-icon .material-symbols-rounded {
        font-size: 20px;
        color: #111827;
    }
    
    #settings-modal-backdrop {
        align-items: flex-end; 
        justify-content: center;
    }
    #settings-modal {
        max-width: 768px; 
        padding-top: 24px;
        padding-bottom: 40px;
        border-radius: 20px 20px 0 0;
        transform: translateY(100%); 
    }
    .modal-backdrop.visible #settings-modal {
        transform: translateY(0);
    }
    #settings-modal h3 {
        font-size: 1.1em;
        font-weight: 600;
        margin: 0 0 16px 0;
        padding: 0 10px;
    }
    
    #reset-chat-button {
        color: #ef4444; 
        padding-left: 10px;
        padding-right: 10px;
    }
    #reset-chat-button .modal-option-icon {
        display: none; 
    }
    
  </style>
</head>
<body>
  <div class="phone" role="application" aria-label="ì±„íŒ… UI">
    <header class="header">
        <div class="header-icon menu-icon">
            <span class="material-symbols-rounded">menu</span>
        </div>
        <div class="plus-btn">
            Ultra ì´ìš©í•˜ê¸°
        </div>
        
        <div class="header-icon" id="settings-button" aria-label="ì„¤ì •">
            <span class="material-symbols-rounded">settings</span>
        </div>
        
    </header>

    <main class="content-wrapper">
        <div id="initial-content">
            <div class="main-question">ì•ˆë…•í•˜ì„¸ìš”! ë°˜ê°€ì›Œìš”</div>
            <div class="quick-actions">
                <div class="action-btn new-green" data-prompt="í…ìŠ¤íŠ¸ì™€ í•¨ê»˜ ëŒ€í™”í•˜ê¸°">
                    <span class="material-symbols-rounded">chat</span>
                    í…ìŠ¤íŠ¸ì™€ í•¨ê»˜ ëŒ€í™”í•˜ê¸°
                </div>
                <div class="action-btn" data-prompt="ë¸Œë ˆì¸ìŠ¤í† ë° ì‹œì‘">
                    <div class="icon-light">ğŸ’¡</div>
                    ë¸Œë ˆì¸ìŠ¤í† ë°
                </div>
                <div class="action-btn new-blue" data-prompt="ê¸€ ì“°ê¸° ì˜ˆì‹œ ìš”ì²­">
                    <span class="material-symbols-rounded">edit</span>
                    ê¸€ ì“°ê¸°
                </div>
                <div class="action-btn orange" data-prompt="í…ìŠ¤íŠ¸ ìš”ì•½ ë°©ë²• ì•Œë ¤ì£¼ê¸°">
                    <span class="material-symbols-rounded">description</span>
                    í…ìŠ¤íŠ¸ ìš”ì•½
                </div>
                <div class="action-btn" data-prompt="ë„ì›€ë§">
                    <div style="font-size:18px;">...</div>
                    ë” ë³´ê¸°
                </div>
            </div>
        </div>

        <div id="chat-messages" class="chat-messages">
            </div>
    </main>

    <div id="composer" class="composer">
      <div class="composer-inner">
        <div class="plus" id="plus-button" aria-label="íŒŒì¼ ì²¨ë¶€">
            <span class="material-symbols-rounded">add</span>
        </div>

        <div id="input-container" class="input-container">
          <textarea id="message-input" placeholder="Minsu GPT" rows="1"></textarea>
          
          <div class="mic-voice-container">
            <div id="mic-icon" class="mic-icon">
                <span class="material-symbols-rounded">mic</span>
            </div>
            
            <div id="action-button-container">
                <div id="send-button" class="send-btn">
                  <span class="material-symbols-rounded">arrow_upward</span>
                </div>
                <div id="stop-button" class="stop-btn" style="display:none;">
                    <span class="material-symbols-rounded">stop</span>
                </div>
            </div>
          </div>
        </div>
      </div>
    </div>
    
    <div id="plus-modal-backdrop" class="modal-backdrop">
        <div id="plus-modal" class="modal">
            <div class="modal-handle"></div>
            
            <div class="modal-grid">
                <div class="modal-grid-item" data-action="camera">
                    <div class="modal-grid-icon">
                        <span class="material-symbols-rounded">photo_camera</span>
                    </div>
                    ì¹´ë©”ë¼
                </div>
                <div class="modal-grid-item" data-action="album">
                    <div class="modal-grid-icon">
                        <span class="material-symbols-rounded">image</span>
                    </div>
                    ì•¨ë²”
                </div>
                <div class="modal-grid-item" data-action="file">
                    <div class="modal-grid-icon">
                        <span class="material-symbols-rounded">upload_file</span>
                    </div>
                    íŒŒì¼
                </div>
            </div>
            
            <div class="modal-option" data-action="create-image">
                <div class="modal-option-icon">
                    <span class="material-symbols-rounded">auto_fix_high</span>
                </div>
                ì´ë¯¸ì§€ ë§Œë“¤ê¸°
            </div>
            
            <div class="modal-option" data-action="set-reminder">
                <div class="modal-option-icon">
                    <span class="material-symbols-rounded">notifications</span>
                </div>
                ë¦¬ë§ˆì¸ë” ë“±ë¡í•˜ê¸°
            </div>
            
        </div>
    </div>
    
    <div id="settings-modal-backdrop" class="modal-backdrop">
        <div id="settings-modal" class="modal">
            <div class="modal-handle"></div>
            <h3>ì„¤ì •</h3>
            
            <div class="modal-option" id="reset-chat-button">
                <div class="modal-option-icon">
                </div>
                ëŒ€í™” ì´ˆê¸°í™”
            </div>
            
        </div>
    </div>
    
  </div>

  <script>
    // ----------------------------------------------
    // |         ì›¹í˜ì´ì§€ ë³µì œ ë°©ì§€ ê¸°ëŠ¥ ì‹œì‘         |
    // ----------------------------------------------
    document.addEventListener('contextmenu', function(e) {
      e.preventDefault(); 
    });

    document.onkeydown = function(e) {
      if (e.keyCode == 123) { e.preventDefault(); return false; } 
      if (e.ctrlKey && e.shiftKey && (e.keyCode == 'I'.charCodeAt(0) || e.keyCode == 'J'.charCodeAt(0) || e.keyCode == 'C'.charCodeAt(0))) { e.preventDefault(); return false; } 
      if (e.ctrlKey && e.keyCode == 'U'.charCodeAt(0)) { e.preventDefault(); return false; } 
    };
    // ----------------------------------------------
    // |         ì›¹í˜ì´ì§€ ë³µì œ ë°©ì§€ ê¸°ëŠ¥ ë           |
    // ----------------------------------------------

    const inputField = document.getElementById('message-input');
    const sendButton = document.getElementById('send-button');
    const stopButton = document.getElementById('stop-button');
    const initialContent = document.getElementById('initial-content');
    const chatMessages = document.getElementById('chat-messages');
    const composer = document.getElementById('composer');
    const inputContainer = document.getElementById('input-container');
    const plusButton = document.getElementById('plus-button');
    const plusModalBackdrop = document.getElementById('plus-modal-backdrop');
    const settingsButton = document.getElementById('settings-button');
    const settingsModalBackdrop = document.getElementById('settings-modal-backdrop');
    const resetChatButton = document.getElementById('reset-chat-button');
    const quickActionButtons = document.querySelectorAll('.action-btn'); 

    // ğŸŒŸğŸŒŸğŸŒŸ ë°±ì—”ë“œ ì—”ë“œí¬ì¸íŠ¸ ì„¤ì • (ì‚¬ìš©ì ì£¼ì†Œ ë°˜ì˜) ğŸŒŸğŸŒŸğŸŒŸ
    const BACKEND_ENDPOINT = "https://jaewondev.pythonanywhere.com/ask"; 
    const HISTORY_STORAGE_KEY = 'minsugpt_chat_history'; // ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ í‚¤

    // ğŸŒŸğŸŒŸğŸŒŸ ëŒ€í™” ê¸°ë¡ì„ ì €ì¥í•  ë°°ì—´ (ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ì—ì„œ ë¡œë“œë¨) ğŸŒŸğŸŒŸğŸŒŸ
    let history = []; 

    const MAX_ROWS = 6;
    const MIN_ROWS = 1;
    const isMobile = () => /Mobi|Android|iPhone|iPad|iPod/i.test(navigator.userAgent) || window.innerWidth <= 768;
    let isStreaming = false; 
    let abortController = null; 
    
    // ğŸŒŸ ë¡œë”© í…ìŠ¤íŠ¸ë¥¼ ì €ì¥í•  ë³€ìˆ˜
    let currentLoadingText = 'ë‹µë³€ì„ ìƒê°í•˜ëŠ” ì¤‘...';


    /**
     * ğŸŒŸ ëŒ€í™” ê¸°ë¡ì„ ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ì—ì„œ ë¡œë“œí•˜ê³  UIì— í‘œì‹œ
     */
    function loadChatHistory() {
        const storedHistory = localStorage.getItem(HISTORY_STORAGE_KEY);
        if (storedHistory) {
            try {
                history = JSON.parse(storedHistory);
                if (history.length > 0) {
                    initialContent.style.display = 'none';
                    chatMessages.style.display = 'flex';
                    history.forEach(message => {
                        if (message.role === 'user') {
                            appendUserMessage(message.content, false);
                        } else if (message.role === 'model') {
                            appendBotMessage(message.content, message.feedback, false);
                        }
                    });
                    chatMessages.scrollTop = chatMessages.scrollHeight;
                    initialContent.style.opacity = '0'; // ë¡œë”© í›„ ì´ˆê¸° í™”ë©´ ìˆ¨ê¹€
                }
            } catch (e) {
                console.error("Failed to parse history from localStorage:", e);
                history = [];
                // ì˜¤ë¥˜ ë°œìƒ ì‹œ ì´ˆê¸° í™”ë©´ í‘œì‹œ
                initialContent.style.display = 'flex';
                initialContent.style.opacity = '1'; 
                chatMessages.style.display = 'none';
            }
        }
        autoResizeTextarea();
    }
    
    /**
     * ğŸŒŸ ëŒ€í™” ê¸°ë¡ì„ ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ì— ì €ì¥
     */
    function saveChatHistory() {
        localStorage.setItem(HISTORY_STORAGE_KEY, JSON.stringify(history));
    }
    
    /**
     * ğŸŒŸ ëŒ€í™” ê¸°ë¡ ì´ˆê¸°í™” ë° UI ë¦¬ì…‹
     */
    function resetChat() {
        if (!confirm("í˜„ì¬ ëŒ€í™” ê¸°ë¡ì„ ëª¨ë‘ ì‚­ì œí•˜ê³  ì´ˆê¸°í™”í•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) {
            return;
        }
        
        // 1. ìƒíƒœ ë° ê¸°ë¡ ì´ˆê¸°í™”
        history = [];
        localStorage.removeItem(HISTORY_STORAGE_KEY);
        
        // 2. UI ì´ˆê¸°í™”
        chatMessages.innerHTML = '';
        chatMessages.style.display = 'none';
        
        initialContent.style.opacity = '0';
        initialContent.style.display = 'flex';
        setTimeout(() => {
            initialContent.style.opacity = '1';
        }, 10); // ì• ë‹ˆë©”ì´ì…˜ì„ ìœ„í•´ ë”œë ˆì´
        
        // 3. ëª¨ë‹¬ ë‹«ê¸°
        toggleSettingsModal(false);
        alert("ëŒ€í™”ê°€ ì´ˆê¸°í™”ë˜ì—ˆìŠµë‹ˆë‹¤.");
    }

    function toggleSendButton() {
        if (inputField.value.trim().length > 0 && !isStreaming) {
            sendButton.classList.add('active');
        } else {
            sendButton.classList.remove('active');
        }
    }
    inputField.addEventListener('input', toggleSendButton);

    function autoResizeTextarea() {
        const style = getComputedStyle(inputField);
        const line_height_px = parseFloat(style.getPropertyValue('--line-height-px')) || 22.4; 
        const composerPaddingV = 12; 
        const inputContainerPaddingV = 8; 
        const minInputContainerHeight = parseFloat(style.getPropertyValue('--min-input-container-height')) || 48; 

        inputField.rows = MIN_ROWS;
        inputField.style.height = 'auto'; 

        let scrollH = inputField.scrollHeight;
        let newRows = Math.round(scrollH / line_height_px);
        newRows = Math.max(MIN_ROWS, Math.min(MAX_ROWS, newRows));
        inputField.rows = newRows;
        inputField.style.height = 'auto';
        
        const finalTextareaHeight = inputField.offsetHeight; 
        const contentHeight = finalTextareaHeight + inputContainerPaddingV;
        const inputContainerHeight = Math.max(contentHeight, minInputContainerHeight);
        
        inputContainer.style.minHeight = `${inputContainerHeight}px`;

        const newComposerHeight = inputContainerHeight + composerPaddingV;
        composer.style.minHeight = `${newComposerHeight}px`;
        
        chatMessages.style.paddingBottom = `${newComposerHeight}px`;

        chatMessages.scrollTop = chatMessages.scrollHeight;
    }
    
    inputField.addEventListener('input', autoResizeTextarea);
    
    /**
     * ì‚¬ìš©ì ë©”ì‹œì§€ ë²„ë¸”ì„ UIì— ì¶”ê°€í•©ë‹ˆë‹¤.
     */
    function appendUserMessage(content, animate = true) {
        const userBubble = document.createElement('div');
        userBubble.className = 'message-bubble user-message';
        userBubble.innerHTML = `<div class="message-text">${content}</div>`;
        chatMessages.appendChild(userBubble);
        if (animate) chatMessages.scrollTop = chatMessages.scrollHeight;
    }


    /**
     * ğŸŒŸ ë´‡ ë©”ì‹œì§€ ì•¡ì…˜ ë²„íŠ¼ ìƒì„±
     */
    function createBotActions(content, messageIndex, feedbackStatus = null) {
        const actionsContainer = document.createElement('div');
        actionsContainer.className = 'bot-actions';

        // 1. ì¢‹ì•„ìš” ë²„íŠ¼ (Like)
        const likeBtn = createActionButton('like', 'ì¢‹ì•„ìš”', feedbackStatus, 'thumb_up');
        
        // 2. ì‹«ì–´ìš” ë²„íŠ¼ (Dislike)
        const dislikeBtn = createActionButton('dislike', 'ì‹«ì–´ìš”', feedbackStatus, 'thumb_down');
        
        // 3. ë³µì‚¬ ë²„íŠ¼ (Copy)
        const copyBtn = createActionButton('copy', 'ë³µì‚¬', null, 'content_copy');
        copyBtn.addEventListener('click', () => {
            navigator.clipboard.writeText(content).then(() => {
                alert('ë©”ì‹œì§€ê°€ ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤.');
            }).catch(err => {
                console.error('ë³µì‚¬ ì‹¤íŒ¨: ', err);
                alert('ë³µì‚¬ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
            });
        });
        
        // 4. ê³µìœ  ë²„íŠ¼ (Share)
        const shareBtn = createActionButton('share', 'ê³µìœ ', null, 'share');
        shareBtn.addEventListener('click', () => {
            if (navigator.share) {
                navigator.share({
                    title: 'MinsuGPT ê³µìœ ',
                    text: content,
                }).catch(error => console.error('ê³µìœ  ì‹¤íŒ¨', error));
            } else {
                navigator.clipboard.writeText(content).then(() => {
                    alert('ê³µìœ  ê¸°ëŠ¥ì´ ì§€ì›ë˜ì§€ ì•Šì•„ ë©”ì‹œì§€ë¥¼ ë³µì‚¬í–ˆìŠµë‹ˆë‹¤.');
                }).catch(err => {
                    console.error('ë³µì‚¬ ì‹¤íŒ¨: ', err);
                    alert('ê³µìœ  ë° ë³µì‚¬ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
                });
            }
        });

        // 5. ë‹¤ì‹œ ë‹µë³€ ë²„íŠ¼ (Regenerate)
        const regenerateBtn = createActionButton('regenerate', 'ë‹¤ì‹œ ë‹µë³€ë°›ê¸°', null, 'autorenew');
        regenerateBtn.addEventListener('click', () => {
            if (isStreaming) {
                alert('í˜„ì¬ ë‹µë³€ ìƒì„± ì¤‘ì…ë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ ì£¼ì„¸ìš”.');
                return;
            }
            
            const lastUserMessage = history.slice().reverse().find(msg => msg.role === 'user');
            if (lastUserMessage) {
                const lastModelIndex = history.findIndex((msg, index) => index === messageIndex);
                if (lastModelIndex !== -1) {
                    history.splice(lastModelIndex, 1);
                }
                
                const botMessageElement = document.querySelector(`.bot-message[data-index="${messageIndex}"]`);
                if (botMessageElement) {
                     botMessageElement.remove();
                }
                
                // ğŸŒŸ ì¬ì‘ë‹µ ë¡œë”© í…ìŠ¤íŠ¸ ì„¤ì • í›„ ì „ì†¡
                currentLoadingText = 'ë‹¤ì‹œ ë‹µë³€ì„ ìƒê°í•˜ëŠ” ì¤‘...';
                const originalPrompt = lastUserMessage.content;
                
                sendMessage(originalPrompt);
            } else {
                alert('ë‹¤ì‹œ ë‹µë³€ë°›ì„ ì´ì „ ì‚¬ìš©ì ë©”ì‹œì§€ê°€ ì—†ìŠµë‹ˆë‹¤.');
            }
        });


        // ì¢‹ì•„ìš”/ì‹«ì–´ìš” ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
        const toggleFeedback = (action, otherAction, index) => {
            const currentMessage = history[index];
            if (!currentMessage || currentMessage.role !== 'model') return;

            const newFeedback = currentMessage.feedback === action ? null : action;
            currentMessage.feedback = newFeedback;
            history[index].feedback = newFeedback; // history ì—…ë°ì´íŠ¸

            saveChatHistory(); // ê¸°ë¡ ì €ì¥

            // UI ì—…ë°ì´íŠ¸
            const btn = document.querySelector(`.bot-message[data-index="${index}"] .bot-action-btn.${action}`);
            const otherBtn = document.querySelector(`.bot-message[data-index="${index}"] .bot-action-btn.${otherAction}`);

            if (newFeedback) {
                btn.classList.add('selected');
                if (otherBtn) otherBtn.classList.remove('selected');
            } else {
                btn.classList.remove('selected');
            }
        };

        likeBtn.addEventListener('click', () => toggleFeedback('like', 'dislike', messageIndex));
        dislikeBtn.addEventListener('click', () => toggleFeedback('dislike', 'like', messageIndex));
        
        actionsContainer.appendChild(likeBtn);
        actionsContainer.appendChild(dislikeBtn);
        actionsContainer.appendChild(copyBtn);
        actionsContainer.appendChild(shareBtn);
        actionsContainer.appendChild(regenerateBtn);

        return actionsContainer;
    }
    
    /**
     * ğŸŒŸ Material Symbols ì•„ì´ì½˜ ìƒì„± í—¬í¼
     */
    function createActionButton(actionType, ariaLabel, feedbackStatus = null, iconName) {
        const btn = document.createElement('div');
        btn.className = `bot-action-btn ${actionType}`;
        btn.setAttribute('role', 'button');
        btn.setAttribute('aria-label', ariaLabel);
        
        if (feedbackStatus === actionType) {
            btn.classList.add('selected');
        }

        btn.innerHTML = `<span class="material-symbols-rounded">${iconName}</span>`;
        return btn;
    }
    
    /**
     * ë´‡ ë©”ì‹œì§€ ì»¨í…Œì´ë„ˆë¥¼ ìƒì„±í•˜ê³  'ìƒê°í•˜ëŠ” ì¤‘...' í‘œì‹œê¸° í¬í•¨
     */
    function appendBotMessageContainer() {
        const botMessageContainer = document.createElement('div');
        botMessageContainer.className = 'bot-message';
        botMessageContainer.setAttribute('data-index', history.length); 
        
        // ğŸ’¡ ìƒê°í•˜ëŠ” ì¤‘... í‘œì‹œê¸°
        const indicatorContainer = document.createElement('div');
        indicatorContainer.id = 'thinking-indicator';
        indicatorContainer.className = 'thinking-indicator';
        
        const indicatorText = document.createElement('span');
        indicatorText.className = 'thinking-indicator-text';
        indicatorText.textContent = currentLoadingText; 
        
        // ğŸŒŸ ìŠ¤í”¼ë„ˆ ì—˜ë¦¬ë¨¼íŠ¸ ì¶”ê°€
        const spinner = document.createElement('div');
        spinner.className = 'loading-spinner';

        indicatorContainer.appendChild(indicatorText);
        indicatorContainer.appendChild(spinner);
        
        // ğŸŒŸ ìŠ¤íŠ¸ë¦¬ë°ë˜ëŠ” í…ìŠ¤íŠ¸ê°€ ë“¤ì–´ê°ˆ ì»¨í…Œì´ë„ˆ
        const streamingBlock = document.createElement('div');
        streamingBlock.className = 'streaming-block'; 
        
        botMessageContainer.appendChild(indicatorContainer);
        botMessageContainer.appendChild(streamingBlock);

        chatMessages.appendChild(botMessageContainer);
        chatMessages.scrollTop = chatMessages.scrollHeight;
        
        return { 
            botMessageElement: botMessageContainer,
            indicatorElement: indicatorContainer, 
            streamingBlockElement: streamingBlock 
        };
    }
    
    /**
     * ğŸŒŸ ë¡œë”© ì™„ë£Œ í›„ ë´‡ ë©”ì‹œì§€ì— ì•¡ì…˜ ë²„íŠ¼ì„ ì¶”ê°€í•©ë‹ˆë‹¤.
     */
    function appendBotMessage(content, feedbackStatus, animate = true) {
        const botMessageContainer = document.createElement('div');
        botMessageContainer.className = 'bot-message';
        
        const messageIndex = history.length - 1; 
        botMessageContainer.setAttribute('data-index', messageIndex);

        const streamingBlock = document.createElement('div');
        streamingBlock.className = 'streaming-block'; 
        streamingBlock.innerHTML = renderMarkdown(content);
        
        const actionsContainer = createBotActions(content, messageIndex, feedbackStatus);

        botMessageContainer.appendChild(streamingBlock);
        botMessageContainer.appendChild(actionsContainer);
        
        chatMessages.appendChild(botMessageContainer);
        if (animate) chatMessages.scrollTop = chatMessages.scrollHeight;
    }


    function startStreamingUI(indicator) {
        // 'ìƒê°í•˜ëŠ” ì¤‘...' ìˆ¨ê¸°ê¸°
        indicator.style.display = 'none';
        // ğŸŒŸ ë¡œë”© í…ìŠ¤íŠ¸ ê¸°ë³¸ê°’ìœ¼ë¡œ ë¦¬ì…‹
        currentLoadingText = 'ë‹µë³€ì„ ìƒê°í•˜ëŠ” ì¤‘...';
    }

    /**
     * ì›ë³¸ ë§ˆí¬ë‹¤ìš´ í…ìŠ¤íŠ¸ë¥¼ HTMLë¡œ ë³€í™˜í•©ë‹ˆë‹¤.
     */
    function renderMarkdown(rawText) {
        if (!rawText) return "";
        let html = rawText.replace(/\r/g, ''); 
        
        // 1. ë¸”ë¡ ì½”ë“œ ```code```
        html = html.replace(/```([^`]+?)```/gs, (match, content) => {
             return `<pre><code>${content.trim()}</code></pre>`;
        });
        
        // 2. í—¤ë” (#, ##, ###)
        html = html.replace(/^(#+)\s*([^\n]+)/gm, (match, hashes, content) => {
            return `<h${hashes.length}>${content}</h${hashes.length}>`;
        });
        
        // 3. ì¸ë¼ì¸ ì½”ë“œ `code`
        html = html.replace(/`([^`\n]+?)`/g, '<code>$1</code>');

        // 4. êµµì€ ê¸€ì”¨ **text** ë˜ëŠ” __text__
        html = html.replace(/\*\*([^\*]+?)\*\*/g, '<strong>$1</strong>');
        html = html.replace(/__([^__]+?)__/g, '<strong>$1</strong>');
        
        // 5. ë‹¨ì¼ ì¤„ë°”ê¿ˆì„ <br>ë¡œ ë³€í™˜
        html = html.replace(/\n/g, '<br>');
        
        return html;
    }
    
    /**
     * ìŠ¤íŠ¸ë¦¬ë°ë˜ëŠ” ì „ì²´ í…ìŠ¤íŠ¸ë¥¼ ê¸°ë°˜ìœ¼ë¡œ ë‚´ìš©ì„ ë®ì–´ì”ë‹ˆë‹¤.
     */
    function updateStreamingDisplay(rawResponse, streamingElement) {
        streamingElement.innerHTML = renderMarkdown(rawResponse);
        chatMessages.scrollTop = chatMessages.scrollHeight;
    }


    // ì¤‘ì§€ ë²„íŠ¼ í™œì„±í™”/ë¹„í™œì„±í™” ë° ìƒíƒœ ì—…ë°ì´íŠ¸
    function setStreamingState(active) {
        isStreaming = active;
        if (active) {
            sendButton.style.display = 'none';
            stopButton.style.display = 'flex';
            inputField.setAttribute('readonly', 'true');
        } else {
            sendButton.style.display = 'flex';
            stopButton.style.display = 'none';
            inputField.removeAttribute('readonly');
            abortController = null;
        }
        toggleSendButton();
    }
    
    // ì¤‘ì§€ ë²„íŠ¼ í•¸ë“¤ëŸ¬
    function stopResponse() {
        if (abortController) {
            abortController.abort();
            
            const lastBotMessageElement = chatMessages.lastElementChild;
            if (lastBotMessageElement) {
                const indicator = lastBotMessageElement.querySelector('#thinking-indicator');
                const streamingBlock = lastBotMessageElement.querySelector('.streaming-block');

                // indicatorê°€ ì•„ì§ ë‚¨ì•„ìˆë‹¤ë©´ ë©”ì‹œì§€ë¥¼ ì¶”ê°€í•˜ì§€ ì•Šê³  ì‚­ì œ
                if (indicator && indicator.style.display !== 'none') {
                    lastBotMessageElement.remove(); 
                    
                    // historyì—ì„œ ë§ˆì§€ë§‰ í•­ëª© ì œê±° (ì‚¬ìš©ì ë©”ì‹œì§€)
                    if (history.length > 0 && history[history.length - 1].role === 'user') {
                         history.pop();
                    }
                } 
                else if (streamingBlock && fullResponse.trim().length > 0) {
                    // ìŠ¤íŠ¸ë¦¬ë°ì„ ì¤‘ì§€í•˜ê³  ìµœì¢… í…ìŠ¤íŠ¸ë¡œ ì—…ë°ì´íŠ¸
                    updateStreamingDisplay(fullResponse, streamingBlock);
                    
                    // historyì— ë¶ˆì™„ì „í•œ ì‘ë‹µ ê¸°ë¡
                    history.push({ role: 'model', content: fullResponse });
                    saveChatHistory();
                    
                    // ì•¡ì…˜ ë²„íŠ¼ ì¶”ê°€
                    const actionContainer = createBotActions(fullResponse, history.length - 1);
                    lastBotMessageElement.appendChild(actionContainer);

                } else if (lastBotMessageElement && fullResponse.trim().length === 0) {
                     // ì•„ë¬´ê²ƒë„ ë°›ì§€ ëª»í•˜ê³  ì¤‘ì§€ëœ ê²½ìš°
                     lastBotMessageElement.remove();
                     if (history.length > 0 && history[history.length - 1].role === 'user') {
                         history.pop();
                     }
                }
            }
        }
        setStreamingState(false);
    }
    stopButton.addEventListener('click', stopResponse);

    // ë©”ì‹œì§€ ì „ì†¡ ì²˜ë¦¬
    let fullResponse = ""; 

    async function sendMessage(userMessageOverride = null) {
        const userMessage = userMessageOverride !== null ? userMessageOverride : inputField.value.trim();
        if (userMessage.length === 0 || isStreaming) return;

        // 1. UI í‘œì‹œ ë° history ì—…ë°ì´íŠ¸ (ì¬ìƒì„±ì´ ì•„ë‹ ê²½ìš°)
        if (userMessageOverride === null) {
            currentLoadingText = 'ë‹µë³€ì„ ìƒê°í•˜ëŠ” ì¤‘...';
            
            if (initialContent.style.opacity !== '0') {
                initialContent.style.opacity = '0';
                setTimeout(() => {
                    initialContent.style.display = 'none';
                    chatMessages.style.display = 'flex'; 
                }, 500); 
            } else {
                 chatMessages.style.display = 'flex';
            }

            appendUserMessage(userMessage);
            history.push({ role: 'user', content: userMessage }); 
        } 

        // 2. ì…ë ¥ì°½ ì´ˆê¸°í™” ë° UI ìƒíƒœ ì—…ë°ì´íŠ¸
        if (userMessageOverride === null) {
            inputField.value = '';
            inputField.rows = MIN_ROWS; 
            autoResizeTextarea(); 
        }
        
        // 3. ë´‡ ë©”ì‹œì§€ë¥¼ ìœ„í•œ ì»¨í…Œì´ë„ˆ ì¶”ê°€ ë° ë¡œë”© í‘œì‹œ
        const { botMessageElement, indicatorElement, streamingBlockElement } = appendBotMessageContainer();
        
        // 4. ìŠ¤íŠ¸ë¦¬ë° ìƒíƒœ ì‹œì‘
        setStreamingState(true);
        abortController = new AbortController();
        const signal = abortController.signal;
        
        fullResponse = ""; 
        let buffer = ""; 
        let isFirstChunk = true; 
        
        try {
            const response = await fetch(BACKEND_ENDPOINT, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    message: userMessage,
                    history: history, 
                }),
                signal: signal 
            });

            if (!response.ok) {
                
                startStreamingUI(indicatorElement); 
                let errorMessage = `HTTP Error: ${response.status} ${response.statusText}`;
                if (response.status === 429) {
                    errorMessage = "âš ï¸ ìš”ì²­ ì†ë„ ì œí•œ ì´ˆê³¼: ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ ì£¼ì„¸ìš”.";
                } else if (response.status === 400) {
                    errorMessage = "âš ï¸ ì˜ëª»ëœ ìš”ì²­: ì…ë ¥ ë©”ì‹œì§€ ê¸¸ì´ ë“±ì„ í™•ì¸í•´ ì£¼ì„¸ìš”.";
                } else if (response.status >= 500) {
                     errorMessage = `âš ï¸ ì„œë²„ ì˜¤ë¥˜: ë°±ì—”ë“œì—ì„œ ë¬¸ì œê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. (HTTP ${response.status})`;
                }
                
                streamingBlockElement.innerHTML = `<p style="color:red;">${errorMessage}</p>`;
                setStreamingState(false);
                
                // ì˜¤ë¥˜ ë°œìƒ ì‹œ historyì—ì„œ ë§ˆì§€ë§‰ ì‚¬ìš©ì ë©”ì‹œì§€ ì œê±°
                if (history.length > 0 && history[history.length - 1].role === 'user') {
                     history.pop();
                     saveChatHistory();
                }
                return;
            }

            const reader = response.body.getReader();
            const decoder = new TextDecoder('utf-8');
            
            while (true) {
                const { done, value } = await reader.read();
                if (done) {
                    break;
                }
                
                buffer += decoder.decode(value, { stream: true });
                
                const parts = buffer.split('\n');
                buffer = parts.pop(); 

                for (const part of parts) {
                    const cleanPart = part; 
                    if (cleanPart.trim() === "[DONE]") {
                        fullResponse += buffer;
                        updateStreamingDisplay(fullResponse, streamingBlockElement);
                        
                        // ğŸŒŸ ìŠ¤íŠ¸ë¦¬ë° ì¢…ë£Œ í›„ ìµœì¢… ì²˜ë¦¬
                        setStreamingState(false);
                        history.push({ role: 'model', content: fullResponse, feedback: null });
                        saveChatHistory();
                        
                        // ì•¡ì…˜ ë²„íŠ¼ ì¶”ê°€
                        botMessageElement.removeChild(indicatorElement); 
                        const actionContainer = createBotActions(fullResponse, history.length - 1);
                        botMessageElement.appendChild(actionContainer);
                        
                        reader.releaseLock();
                        return; 
                    }
                    
                    if (cleanPart.length > 0) {
                        if (isFirstChunk) {
                            startStreamingUI(indicatorElement); 
                            isFirstChunk = false;
                        }
                        
                        fullResponse += cleanPart + '\n'; 
                        
                        updateStreamingDisplay(fullResponse, streamingBlockElement);
                    }
                }
            }
            
            if (buffer.length > 0) {
                 if (isFirstChunk) {
                    startStreamingUI(indicatorElement);
                    isFirstChunk = false;
                 }
                 fullResponse += buffer;
                 updateStreamingDisplay(fullResponse, streamingBlockElement);
            }
            
            if (isStreaming) {
                 // ğŸŒŸ ìŠ¤íŠ¸ë¦¬ë° ì¢…ë£Œ í›„ ìµœì¢… ì²˜ë¦¬
                 setStreamingState(false);
                 history.push({ role: 'model', content: fullResponse, feedback: null });
                 saveChatHistory();
                 
                 // ì•¡ì…˜ ë²„íŠ¼ ì¶”ê°€
                 botMessageElement.removeChild(indicatorElement); 
                 const actionContainer = createBotActions(fullResponse, history.length - 1);
                 botMessageElement.appendChild(actionContainer);
            }


        } catch (error) {
            if (error.name === 'AbortError') {
                console.log('Fetch aborted by user or cleanup triggered.');
            } else {
                console.error('Fetch/Streaming Error:', error);
                const errorMsg = `âš ï¸ í†µì‹  ì˜¤ë¥˜: ì„œë²„ì— ì—°ê²°í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤. CORS ì„¤ì • ë˜ëŠ” ì£¼ì†Œë¥¼ í™•ì¸í•´ ì£¼ì„¸ìš”. (Error: ${error.message})`;
                
                startStreamingUI(indicatorElement);
                streamingBlockElement.innerHTML = `<p style="color:red;">${errorMsg}</p>`;
                
                // ì˜¤ë¥˜ ë°œìƒ ì‹œ historyì—ì„œ ë§ˆì§€ë§‰ ì‚¬ìš©ì ë©”ì‹œì§€ ì œê±° (ì™„ì „í•œ ì‘ë‹µ ì‹¤íŒ¨)
                if (history.length > 0 && history[history.length - 1].role === 'user') {
                     history.pop();
                     saveChatHistory();
                }
            }
            setStreamingState(false);
        }
        if(isStreaming) setStreamingState(false);
    }

    sendButton.addEventListener('click', () => sendMessage());

    // ğŸŒŸ Quick Action ë²„íŠ¼ í´ë¦­ ì´ë²¤íŠ¸
    quickActionButtons.forEach(button => {
        button.addEventListener('click', () => {
            const prompt = button.getAttribute('data-prompt');
            if (prompt) {
                inputField.value = prompt;
                autoResizeTextarea();
                sendMessage();
            }
        });
    });

    // ì—”í„°í‚¤ ë™ì‘
    inputField.addEventListener('keydown', (e) => {
        if (e.key === 'Enter') {
            if (isMobile()) {
            } else {
                if (e.shiftKey) {
                    setTimeout(autoResizeTextarea, 0); 
                    return; 
                }
                e.preventDefault(); 
                if (sendButton.classList.contains('active') && !isStreaming) {
                    sendMessage();
                }
            }
        }
    });

    // ğŸŒŸğŸŒŸğŸŒŸ í”ŒëŸ¬ìŠ¤ ë²„íŠ¼ ëª¨ë‹¬ í† ê¸€ ë¡œì§ ğŸŒŸğŸŒŸğŸŒŸ
    function togglePlusModal(show) {
        if (show === undefined) {
            plusModalBackdrop.classList.toggle('visible');
        } else if (show) {
            plusModalBackdrop.classList.add('visible');
        } else {
            plusModalBackdrop.classList.remove('visible');
        }
    }

    plusButton.addEventListener('click', (e) => {
        e.preventDefault(); 
        togglePlusModal();
    });
    
    // í”ŒëŸ¬ìŠ¤ ëª¨ë‹¬ ë°°ê²½ í´ë¦­ ì‹œ ë‹«ê¸°
    plusModalBackdrop.addEventListener('click', (e) => {
        if (e.target === plusModalBackdrop) {
            togglePlusModal(false);
        }
    });
    // ëª¨ë‹¬ ë‚´ë¶€ ë²„íŠ¼ í´ë¦­ ì‹œ ë‹«ê¸° (ì‹¤ì œ ê¸°ëŠ¥ì€ ì—¬ê¸°ì— êµ¬í˜„í•´ì•¼ í•¨)
    document.getElementById('plus-modal').addEventListener('click', (e) => {
        if (e.target.closest('.modal-grid-item') || e.target.closest('.modal-option')) {
            // togglePlusModal(false); 
        }
    });
    
    // ğŸŒŸğŸŒŸğŸŒŸ ì„¤ì • ëª¨ë‹¬ í† ê¸€ ë¡œì§ ğŸŒŸğŸŒŸğŸŒŸ
    function toggleSettingsModal(show) {
        if (show === undefined) {
            settingsModalBackdrop.classList.toggle('visible');
        } else if (show) {
            settingsModalBackdrop.classList.add('visible');
        } else {
            settingsModalBackdrop.classList.remove('visible');
        }
    }
    
    settingsButton.addEventListener('click', (e) => {
        e.preventDefault();
        toggleSettingsModal();
    });
    
    // ì„¤ì • ëª¨ë‹¬ ë°°ê²½ í´ë¦­ ì‹œ ë‹«ê¸°
    settingsModalBackdrop.addEventListener('click', (e) => {
        if (e.target === settingsModalBackdrop) {
            toggleSettingsModal(false);
        }
    });
    
    // ëŒ€í™” ì´ˆê¸°í™” ë²„íŠ¼ í´ë¦­ ì‹œ
    resetChatButton.addEventListener('click', resetChat);


    // ì´ˆê¸° ìƒíƒœ ë¡œë“œ ë° ë†’ì´ ì¡°ì •
    loadChatHistory();
    toggleSendButton();
    autoResizeTextarea();
  </script>
</body>
</html>
