<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>MinsuGPT</title> 
  
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Elms+Sans:ital,wght@0,100..900;1,100..900;0,100..900;1,100..900&display=swap" rel="stylesheet">
  
  <link href="https://fonts.googleapis.com/icon?family=Material+Symbols+Rounded" rel="stylesheet">
  
  <style>
    :root{
      --bg: #ffffff;
      --accent:#111827; 
      --send-button-disabled: #9ca3af;
      --send-button-enabled: #111827; 
      --composer-padding: 6px 12px;
      --composer-padding-v: 12px; 
      --input-container-padding-v: 8px; 
      --font-size: 16px;
      --line-height: 1.4;
      
      --line-height-px: 22.4; 
      --min-textarea-height: 22.4px; 
      --min-input-container-height: 48px; 
      
      font-family: 'Elms Sans', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Noto Sans KR', 'Helvetica Neue', Arial, sans-serif;
    }
    
    /* Material Symbols ì•„ì´ì½˜ ìŠ¤íƒ€ì¼ */
    .material-symbols-rounded {
      font-family: 'Material Symbols Rounded';
      font-weight: normal;
      font-style: normal;
      font-size: 24px;  /* ê¸°ë³¸ í¬ê¸° */
      line-height: 1;
      letter-spacing: normal;
      text-transform: none;
      display: inline-block;
      white-space: nowrap;
      word-wrap: normal;
      direction: ltr;
      -webkit-font-feature-settings: 'liga';
      -webkit-font-smoothing: antialiased;
      
      font-variation-settings:
        'FILL' 0,
        'wght' 500,
        'GRAD' 0,
        'opsz' 24;
    }
    
    /* ğŸŒŸğŸŒŸğŸŒŸ ì¤‘ì§€ ë²„íŠ¼ ì•„ì´ì½˜ (â– ) CSS ì‚¬ê°í˜• ìŠ¤íƒ€ì¼ ğŸŒŸğŸŒŸğŸŒŸ */
    .stop-btn .stop-icon {
        /* ê¸°ì¡´ í…ìŠ¤íŠ¸ ëŒ€ì‹  CSSë¡œ ì‚¬ê°í˜• ëª¨ì–‘ êµ¬í˜„ */
        display: block;
        width: 12px; 
        height: 12px; 
        background-color: white; 
        border-radius: 2px;
    }
    .stop-btn {
        background-color: #ef4444; 
        width:38px; 
        height:38px;
        border-radius: 50%; /* ì›í˜• */
        display:flex;
        align-items:center;
        justify-content:center;
        padding: 0;
        margin: 0;
    }

    .fa, .fa-solid, .fa-regular {
        font-family: 'Material Symbols Rounded', 'Elms Sans' !important;
        font-weight: 500 !important;
        font-style: normal; 
    }
    
    *{
        box-sizing:border-box;
        -webkit-tap-highlight-color: transparent; 
    }
    body{
      margin:0;
      background:var(--bg);
      color:var(--accent);
      min-height:100vh;
      display:flex;
      justify-content:center;
      padding:0;
    }
    .phone{
      width:100%;
      background:var(--bg);
      border-radius:0;
      overflow:hidden;
      border:none;
      display:flex;
      flex-direction:column;
      min-height:100vh;
      position:relative; 
      margin: 0;
    }

    .header{
      display:flex;
      justify-content:center; /* ğŸŒŸ ìˆ˜ì •: space-betweenì—ì„œ centerë¡œ ë³€ê²½ */
      align-items:center;
      padding:10px 16px;
      height:56px;
      border-bottom:none;
      
      /* ğŸŒŸğŸŒŸğŸŒŸ íƒ‘ë°” ê³ ì • ë¡œì§ ìˆ˜ì • (sticky: top ê³ ì •) ğŸŒŸğŸŒŸğŸŒŸ */
      position: sticky; 
      top: 0;
      z-index: 100; 
      background: var(--bg); 
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05); 
    }
    .header-icon{
      width:32px;
      height:32px;
      display:flex;
      align-items:center;
      justify-content:center;
      color:#111827;
      cursor: pointer; 
      
      /* ğŸŒŸğŸŒŸğŸŒŸ ì¶”ê°€: ì¤‘ì•™ ë°°ì¹˜ë¥¼ ìœ„í•´ ì ˆëŒ€ ìœ„ì¹˜ë¡œ ë³€ê²½ ğŸŒŸğŸŒŸğŸŒŸ */
      position: absolute;
      top: 50%;
      transform: translateY(-50%);
    }
    .menu-icon { /* ğŸŒŸ ì¶”ê°€: ì™¼ìª½ ì•„ì´ì½˜ ìœ„ì¹˜ ê³ ì • */
        left: 16px; 
    }
    #settings-button { /* ğŸŒŸ ì¶”ê°€: ì˜¤ë¥¸ìª½ ì•„ì´ì½˜ ìœ„ì¹˜ ê³ ì • */
        right: 16px;
    }
    .plus-btn{
      background-color:#f1f4ff;
      color:#1d6fef;
      font-weight:600;
      padding:6px 14px;
      border-radius:20px;
      display:flex;
      align-items:center;
      gap:4px;
      font-size:14px;
      cursor: pointer;
    }
    .profile-btn{
      width:32px;
      height:32px;
      border-radius:50%;
      background-color:#e5e8eb;
      display:flex;
      align-items:center;
      justify-content:center;
      color:#111827;
    }

    .content-wrapper{
        flex-grow:1;
        display:flex;
        flex-direction:column;
        /* ìŠ¤í¬ë¡¤ì€ content-wrapperì—ì„œë§Œ ë°œìƒí•˜ë„ë¡ ì„¤ì • */
        overflow-y: auto; 
        padding-bottom: 0; 
        position: relative;
    }
    
    /* ğŸŒŸğŸŒŸğŸŒŸ ìŠ¤í¬ë¡¤ ë‹¤ìš´ ë²„íŠ¼ ìŠ¤íƒ€ì¼ ğŸŒŸğŸŒŸğŸŒŸ */
    #scroll-down-button {
        position: absolute;
        bottom: 10px; 
        right: 20px;
        width: 40px;
        height: 40px;
        border-radius: 50%;
        background-color: #ffffff;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        z-index: 5;
        opacity: 0;
        transform: translateY(10px);
        visibility: hidden;
        transition: opacity 0.3s ease, transform 0.3s ease, visibility 0.3s ease;
    }
    #scroll-down-button.visible {
        opacity: 1;
        transform: translateY(0);
        visibility: visible;
    }
    #scroll-down-button .material-symbols-rounded {
        color: var(--accent);
        font-size: 20px;
    }
    
    #initial-content{
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      width: 100%;
      max-width: 400px;
      display:flex;
      flex-direction:column;
      align-items:center;
      text-align:center;
      padding: 0 16px;
      transition: opacity 0.5s ease-in-out, visibility 0.5s ease-in-out;
    }
    .main-question{
      font-size:22px;
      font-weight:600;
      margin-bottom:40px;
      color:#111827;
    }
    .quick-actions{
      display:flex;
      flex-wrap:wrap;
      justify-content:center;
      gap:8px;
      max-width:400px; 
    }
    .action-btn{
      display:flex;
      align-items:center;
      justify-content:center;
      padding:10px 16px;
      border:1px solid #e5e8eb;
      border-radius:30px;
      font-size:15px;
      font-weight:500;
      color:#111827;
      min-height:48px;
      white-space:nowrap;
      cursor: pointer;
    }
    .action-btn .material-symbols-rounded, .action-btn .icon-light{
      margin-right:6px;
      width:20px;
      height:20px;
      font-size: 18px;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .action-btn.new-green .material-symbols-rounded{ color:#28a745; }
    .action-btn.new-blue .material-symbols-rounded{ color:#007bff; }
    .action-btn.orange .material-symbols-rounded{ color:#fd7e14; } 

    .chat-messages{
      width: 100%;
      padding: 10px 16px;
      display: none;
      flex-direction: column;
      justify-content: flex-start; 
      gap: 10px;
      margin: 0 auto; 
    }
    @media (min-width: 600px) {
        .chat-messages {
            max-width: 768px; 
            padding-left: 0;
            padding-right: 0;
        }
    }

    .message-bubble{
      display: flex;
      max-width: 80%;
    }
    .message-text{
      padding: 10px 14px;
      border-radius: 20px;
      line-height: 1.4;
      font-size: 15px;
      white-space: pre-wrap;
    }
    .user-message{
      justify-content: flex-end;
      align-self: flex-end;
    }
    .user-message .message-text{
      background-color: #f1f4f9; 
      color: var(--accent); 
      border-bottom-right-radius: 4px;
    }
    
    .bot-message{
      align-self: flex-start;
      margin-top: 10px;
      padding: 0; 
      color: var(--accent);
      line-height: 1.4;
      font-size: 15px;
      width: 100%; 
    }
    
    .bot-message .streaming-block {
        display: block;
        padding: 0; 
        border-radius: 0; 
        background-color: transparent; 
        max-width: 100%;
        box-sizing: border-box;
        white-space: normal;
        color: var(--accent); 
        margin-bottom: 8px; 
    }
    
    /* ğŸŒŸ ë‹µë³€ ì¤‘ì§€ ì•Œë¦¼ í…ìŠ¤íŠ¸ ìŠ¤íƒ€ì¼ */
    .stop-message {
        color: #ef4444; 
        font-weight: 600;
        font-size: 0.9em;
        margin-top: -5px; 
        margin-bottom: 10px;
        padding: 0 4px;
        align-self: flex-start;
    }
    
    /* ğŸŒŸğŸŒŸğŸŒŸ ë¬¸ì¥ë³„ í˜ì´ë“œ ì¸ íš¨ê³¼ ğŸŒŸğŸŒŸğŸŒŸ */
    .sentence {
        opacity: 0;
        transition: opacity 0.2s ease-in; 
        display: inline; 
        white-space: pre-wrap; 
    }
    .sentence.visible {
        opacity: 1;
    }
    
    .bot-actions {
        display: flex;
        gap: 8px;
        margin-top: 0px; 
        padding: 4px 0;
        transition: opacity 0.3s;
    }
    
    /* ğŸŒŸğŸŒŸğŸŒŸ ì¬ìƒì„± ë²„íŠ¼ë§Œ ë¹„í™œì„±í™” ğŸŒŸğŸŒŸğŸŒŸ */
    .bot-actions .regenerate {
        opacity: 0.5;
        pointer-events: none;
    }
    

    .bot-action-btn {
        width: 32px;
        height: 32px;
        display: flex;
        align-items: center;
        justify-content: center;
        color: #9ca3af; 
        cursor: pointer;
        border-radius: 50%;
        transition: background-color 0.2s;
    }
    .bot-action-btn:hover {
        background-color: #f3f4f6;
    }
    .bot-action-btn.selected {
        color: var(--accent);
    }
    .bot-action-btn.selected.like {
        color: #1d6fef; 
    }
    .bot-action-btn.selected.dislike {
        color: #ef4444; 
    }

    .bot-action-btn .material-symbols-rounded {
        font-size: 16px;
    }
    .bot-action-btn.selected.like .material-symbols-rounded { color: #1d6fef; }
    .bot-action-btn.selected.dislike .material-symbols-rounded { color: #ef4444; }


    /* ğŸ’¡ ìƒê°í•˜ëŠ” ì¤‘... ì• ë‹ˆë©”ì´ì…˜ ìŠ¤íƒ€ì¼ (ìœ ì§€) */
    .thinking-indicator {
        display: flex;
        align-items: center;
        padding: 10px 0;
    }

    .thinking-indicator-text {
        font-weight: 500;
        margin-right: 8px;
        
        background-color: var(--accent); 
        background-image: linear-gradient(
            90deg,
            #111827 0%,
            #ffffff 20%, 
            #111827 40%
        );
        background-size: 200% 100%; 
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        animation: shimmer 1.5s infinite linear;
    }
    
    .loading-spinner {
        display: inline-block;
        width: 16px;
        height: 16px;
        border: 2px solid #ccc;
        border-top-color: #111827; 
        border-radius: 50%;
        animation: spin 0.8s linear infinite;
        margin-left: 4px;
    }
    @keyframes spin {
        to { transform: rotate(360deg); }
    }

    @keyframes shimmer {
        0% {
            background-position: 100% 0; 
        }
        100% {
            background-position: -100% 0; 
        }
    }

    /* Input area */
    .composer{
        position:fixed; bottom:0; left:0; right:0; width:100%; display:flex; justify-content:center; padding:var(--composer-padding); background:var(--bg); box-shadow:none; height: auto; min-height: calc(var(--min-input-container-height) + var(--composer-padding-v)); z-index: 10; 
        /* ğŸŒŸğŸŒŸğŸŒŸ ë¶€ë“œëŸ¬ìš´ ì• ë‹ˆë©”ì´ì…˜ì„ ìœ„í•œ íŠ¸ëœì§€ì…˜ ì¶”ê°€ ğŸŒŸğŸŒŸğŸŒŸ */
        transition: all 0.2s ease-out; 
    }
    .composer-inner{
        display:flex; align-items:center; gap:8px; width:100%;
    }
    @media (min-width: 600px) {
        .composer-inner {
            max-width: 768px; 
        }
    }

    .input-container{
      flex:1; display:flex; align-items: center; gap:8px; border-radius:24px; border:1px solid #d1d5db; padding:4px 4px 4px 16px; box-sizing:border-box; background:#ffffff; max-height: 150px; overflow: hidden; min-height: var(--min-input-container-height); 
    }
    .input-container textarea{
      flex:1; border:0; outline:0; background:transparent; color:var(--accent); font-size:var(--font-size); min-width:0; resize: none; min-height: var(--min-textarea-height); overflow-y: hidden; padding: 0; line-height: var(--line-height); vertical-align: middle; align-self: center; font-family: inherit; 
    }
    .input-container textarea::placeholder{
        color:#9ca3af;
        font-family: inherit;
    }

    .plus{
      width: var(--min-input-container-height); height: var(--min-input-container-height); border-radius:50%; background:#ffffff; border:1px solid #d1d5db; display:flex; align-items:center; justify-content:center; flex-shrink:0; align-self: center; cursor: pointer;
    }
    .plus .material-symbols-rounded {
      font-size: 20px; 
      color: #111827;
    }

    .mic-voice-container{
        display:flex; gap:8px; flex-shrink:0; margin-bottom: 0;
    }
    .mic-icon{
        width:38px; height:38px; display:flex; align-items:center; justify-content:center; flex-shrink:0; color:#9ca3af;
    }
    .mic-icon .material-symbols-rounded {
        font-size: 20px;
    }

    .send-btn, .stop-btn{
      width:38px; height:38px; border-radius:50%; display:flex; align-items:center; justify-content:center; flex-shrink:0; margin-left:0; margin-right:4px; transition: background-color 0.2s ease; cursor: pointer;
    }
    .send-btn:not(.active) {
        background-color: var(--send-button-disabled);
        pointer-events: none;
    }
    .send-btn.active {
        background-color: var(--send-button-enabled); 
        pointer-events: auto;
    }
    .send-btn .material-symbols-rounded {
        color: white;
        /* ì „ì†¡ ë²„íŠ¼ ì•„ì´ì½˜ í¬ê¸° ë³€ê²½ (í™”ì‚´í‘œì— ë§ê²Œ) */
        font-size: 20px; 
    }


    /* ğŸŒŸğŸŒŸğŸŒŸ ìŠ¤ë‚µë°” ì•Œë¦¼ ìŠ¤íƒ€ì¼ (ëª¨ì„œë¦¬ ë°˜ì› ë³€ê²½) ğŸŒŸğŸŒŸğŸŒŸ */
    #snackbar {
      visibility: hidden; 
      min-width: 250px;
      background-color: #333; 
      color: #fff; 
      text-align: center; 
      border-radius: 30px; /* ğŸŒŸ ë°˜ì› ìŠ¤íƒ€ì¼ë¡œ ë³€ê²½ */
      padding: 12px 20px; 
      position: fixed; 
      z-index: 1020; 
      left: 50%; 
      transform: translateX(-50%);
      bottom: 30px; 
      font-size: 14px; 
      /* ì• ë‹ˆë©”ì´ì…˜ ì´ˆê¸°í™” */
      transition: none; 
      opacity: 0;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
    }
    #snackbar.show {
      visibility: visible;
      opacity: 1;
      animation: fadein 0.5s, fadeout 0.5s 2.5s;
    }

    @keyframes fadein {
      from {bottom: 0; opacity: 0;}
      to {bottom: 30px; opacity: 1;}
    }

    @keyframes fadeout {
      from {bottom: 30px; opacity: 1;}
      to {bottom: 0; opacity: 0;}
    }
    
    /* ì´í•˜ ëª¨ë‹¬ ìŠ¤íƒ€ì¼ì€ ì´ì „ ì½”ë“œì™€ ë™ì¼í•˜ê²Œ ìœ ì§€ */
    /* ===================================== */
    /* ëª¨ë‹¬ ê³µí†µ ìŠ¤íƒ€ì¼ (ìœ ì§€) */
    /* ===================================== */
    .modal-backdrop {
        position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.5); opacity: 0; visibility: hidden; transition: opacity 0.3s ease, visibility 0.3s ease; z-index: 1000; display: flex; justify-content: center; align-items: flex-end;
    }
    .modal-backdrop.visible {
        opacity: 1; visibility: visible;
    }
    .modal {
        width: 100%; max-width: 768px; background-color: var(--bg); border-top-left-radius: 20px; border-top-right-radius: 20px; padding: 24px 16px 40px 16px; transform: translateY(100%); transition: transform 0.3s ease-out;
    }
    .modal-backdrop.visible .modal {
        transform: translateY(0);
    }
    .modal-handle {
        width: 40px; height: 5px; background-color: #e5e8eb; border-radius: 5px; margin: 0 auto 20px auto;
    }
    .modal-grid {
        display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; margin-bottom: 24px;
    }
    .modal-grid-item {
        display: flex; flex-direction: column; align-items: center; text-align: center; padding: 12px 0; background-color: #f1f4f9; border-radius: 12px; font-size: 14px; font-weight: 500; cursor: pointer;
    }
    .modal-grid-icon {
        width: 48px; height: 48px; background-color: #e5e8eb; border-radius: 12px; margin-bottom: 8px; display: flex; align-items: center; justify-content: center;
    }
    .modal-grid-icon .material-symbols-rounded {
        font-size: 24px;
        color: #111827;
    }

    .modal-option {
        display: flex; align-items: center; padding: 12px 10px; font-size: 16px; font-weight: 500; cursor: pointer; border-radius: 8px; transition: background-color 0.1s ease;
    }
    .modal-option:hover {
        background-color: #f1f4f9;
    }
    .modal-option-icon {
        margin-right: 12px; width: 28px; height: 28px; display: flex; align-items: center; justify-content: center;
    }
    .modal-option-icon .material-symbols-rounded {
        font-size: 20px;
        color: #111827;
    }
    
    #settings-modal-backdrop {
        align-items: flex-end; 
        justify-content: center;
    }
    #settings-modal {
        max-width: 768px; 
        padding-top: 24px;
        padding-bottom: 40px;
        border-radius: 20px 20px 0 0;
        transform: translateY(100%); 
    }
    .modal-backdrop.visible #settings-modal {
        transform: translateY(0);
    }
    #settings-modal h3 {
        font-size: 1.1em;
        font-weight: 600;
        margin: 0 0 16px 0;
        padding: 0 10px;
    }
    
    #reset-chat-button {
        color: #ef4444; 
        padding-left: 10px;
        padding-right: 10px;
    }
    #reset-chat-button .modal-option-icon {
        display: none; 
    }
    
    /* ğŸŒŸğŸŒŸğŸŒŸ ëŒ€í™” ì´ˆê¸°í™” í™•ì¸ ëª¨ë‹¬ ìŠ¤íƒ€ì¼ ğŸŒŸğŸŒŸğŸŒŸ */
    #reset-confirm-modal-backdrop {
        align-items: center; 
        z-index: 1010;
    }
    #reset-confirm-modal {
        max-width: 320px;
        border-radius: 12px;
        padding: 24px;
        transform: translateY(0); 
        transition: opacity 0.3s ease, transform 0.3s ease;
    }
    #reset-confirm-modal .modal-handle { display: none; }
    #reset-confirm-modal h3 {
        font-size: 1.2em;
        margin: 0 0 10px 0;
        text-align: center;
        padding: 0;
    }
    #reset-confirm-modal p {
        font-size: 0.95em; 
        color: #6b7280; 
        margin-bottom: 24px; 
        text-align: center; 
    }
    .confirm-actions { 
        display: flex; 
        justify-content: space-between; 
        gap: 10px; 
    }
    .confirm-actions button { 
        flex: 1; 
        padding: 10px 15px; 
        border: none; 
        border-radius: 8px; 
        font-weight: 600; 
        cursor: pointer; 
        font-size: 15px; 
    }
    #confirm-cancel-btn { 
        background-color: #e5e8eb; 
        color: #111827; 
    }
    #confirm-reset-btn { 
        background-color: #ef4444; 
        color: white; 
    } 
    </style>
</head>
<body>
<div class="phone" role="application" aria-label="ì±„íŒ… UI">
<header class="header">
<div class="header-icon menu-icon">
<span class="material-symbols-rounded">menu</span>
</div>
<div class="plus-btn"> Ultra ì´ìš©í•˜ê¸° </div>
<div class="header-icon" id="settings-button" aria-label="ì„¤ì •">
<span class="material-symbols-rounded">settings</span>
</div>
</header>
<main id="content-wrapper" class="content-wrapper">
<div id="scroll-down-button" class="">
<span class="material-symbols-rounded">arrow_downward</span>
</div>
<div id="initial-content">
<div class="main-question">ì•ˆë…•í•˜ì„¸ìš”! ë°˜ê°€ì›Œìš”</div>
<div class="quick-actions">
<div class="action-btn new-green" data-prompt="í…ìŠ¤íŠ¸ì™€ í•¨ê»˜ ëŒ€í™”í•˜ê¸°">
<span class="material-symbols-rounded">chat</span> í…ìŠ¤íŠ¸ì™€ í•¨ê»˜ ëŒ€í™”í•˜ê¸°
</div>
<div class="action-btn" data-prompt="ë¸Œë ˆì¸ìŠ¤í† ë° ì‹œì‘">
<div class="icon-light">ğŸ’¡</div> ë¸Œë ˆì¸ìŠ¤í† ë°
</div>
<div class="action-btn new-blue" data-prompt="ê¸€ ì“°ê¸° ì˜ˆì‹œ ìš”ì²­">
<span class="material-symbols-rounded">edit</span> ê¸€ ì“°ê¸°
</div>
<div class="action-btn orange" data-prompt="í…ìŠ¤íŠ¸ ìš”ì•½ ë°©ë²• ì•Œë ¤ì£¼ê¸°">
<span class="material-symbols-rounded">description</span> í…ìŠ¤íŠ¸ ìš”ì•½
</div>
</div>
</div>
<div id="chat-messages" class="chat-messages">
</div>
</main>
<div id="composer" class="composer">
<div class="composer-inner">
<div id="plus-button" class="plus" aria-label="ì¶”ê°€ ê¸°ëŠ¥">
<span class="material-symbols-rounded">add</span>
</div>
<div id="input-container" class="input-container">
<textarea id="message-input" placeholder="ë©”ì‹œì§€ ì…ë ¥..." rows="1" aria-label="ë©”ì‹œì§€ ì…ë ¥ì°½"></textarea>
<div class="mic-voice-container">
<div class="mic-icon" aria-label="ìŒì„± ì…ë ¥">
<span class="material-symbols-rounded">mic</span>
</div>
</div>
</div>
<div id="send-button" class="send-btn" aria-label="ì „ì†¡">
<span class="material-symbols-rounded">send</span>
</div>
<div id="stop-button" class="stop-btn" style="display: none;" aria-label="ë‹µë³€ ì¤‘ì§€">
<div class="stop-icon"></div>
</div>
</div>
</div>

<div id="plus-modal-backdrop" class="modal-backdrop" aria-hidden="true">
<div id="plus-modal" class="modal" role="dialog" aria-modal="true" aria-labelledby="plus-modal-title">
<div class="modal-handle"></div>
<h3 id="plus-modal-title" style="margin-bottom: 12px; padding: 0 10px; font-size: 1.1em; font-weight: 600;">ê¸°ëŠ¥ ì„ íƒ</h3>
<div class="modal-grid">
<div class="modal-grid-item" data-action="image-upload">
<div class="modal-grid-icon"><span class="material-symbols-rounded">image</span></div>
ì´ë¯¸ì§€ ì—…ë¡œë“œ
</div>
<div class="modal-grid-item" data-action="file-upload">
<div class="modal-grid-icon"><span class="material-symbols-rounded">upload_file</span></div>
íŒŒì¼ ì—…ë¡œë“œ
</div>
<div class="modal-grid-item" data-action="link-share">
<div class="modal-grid-icon"><span class="material-symbols-rounded">link</span></div>
ë§í¬ ê³µìœ 
</div>
</div>
<div class="modal-option" data-action="new-chat">
<div class="modal-option-icon"><span class="material-symbols-rounded">chat</span></div>
ìƒˆë¡œìš´ ëŒ€í™” ì‹œì‘
</div>
<div class="modal-option" data-action="voice-input">
<div class="modal-option-icon"><span class="material-symbols-rounded">mic</span></div>
ìŒì„± ì…ë ¥ ì „í™˜
</div>
</div>
</div>

<div id="settings-modal-backdrop" class="modal-backdrop" aria-hidden="true">
<div id="settings-modal" class="modal" role="dialog" aria-modal="true" aria-labelledby="settings-modal-title">
<div class="modal-handle"></div>
<h3 id="settings-modal-title">ì„¤ì •</h3>
<div class="modal-option" data-action="feedback">
<div class="modal-option-icon"><span class="material-symbols-rounded">feedback</span></div>
í”¼ë“œë°± ë³´ë‚´ê¸°
</div>
<div id="reset-chat-button" class="modal-option" data-action="reset">
<div class="modal-option-icon"><span class="material-symbols-rounded">delete</span></div>
ëŒ€í™” ì´ˆê¸°í™”
</div>
<div class="modal-option" data-action="about">
<div class="modal-option-icon"><span class="material-symbols-rounded">info</span></div>
MinsuGPT ì •ë³´
</div>
</div>
</div>

<div id="reset-confirm-modal-backdrop" class="modal-backdrop" aria-hidden="true">
<div id="reset-confirm-modal" class="modal" role="dialog" aria-modal="true" aria-labelledby="reset-confirm-title">
<div class="modal-handle"></div>
<h3 id="reset-confirm-title">ëŒ€í™” ì´ˆê¸°í™”</h3>
<p>í˜„ì¬ ëŒ€í™”ë¥¼ ì •ë§ë¡œ ì´ˆê¸°í™”í•˜ì‹œê² ìŠµë‹ˆê¹Œ? ì´ ì‘ì—…ì€ ë˜ëŒë¦´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</p>
<div class="confirm-actions">
<button id="confirm-cancel-btn">ì·¨ì†Œ</button>
<button id="confirm-reset-btn">ì´ˆê¸°í™”</button>
</div>
</div>
</div>

<div id="snackbar"></div>

</div>

<script>
// ----------------------------------------------
// | ì›¹í˜ì´ì§€ ë³µì œ ë°©ì§€ ê¸°ëŠ¥ ì‹œì‘ (ê¸°ì¡´ ì½”ë“œ ìœ ì§€) |
// ----------------------------------------------
document.addEventListener('contextmenu', event => event.preventDefault());
document.onkeydown = function(e) {
  if (e.keyCode == 123) {
    e.preventDefault();
    return false;
  }
  if (e.ctrlKey && e.shiftKey && (e.keyCode == 'I'.charCodeAt(0) || e.keyCode == 'J'.charCodeAt(0) || e.keyCode == 'C'.charCodeAt(0))) {
    e.preventDefault();
    return false;
  }
  if (e.ctrlKey && e.keyCode == 'U'.charCodeAt(0)) {
    e.preventDefault();
    return false;
  }
};
// ----------------------------------------------
// | ì›¹í˜ì´ì§€ ë³µì œ ë°©ì§€ ê¸°ëŠ¥ ë |
// ----------------------------------------------

const contentWrapper = document.getElementById('content-wrapper');
const inputField = document.getElementById('message-input');
const sendButton = document.getElementById('send-button');
const stopButton = document.getElementById('stop-button');
const initialContent = document.getElementById('initial-content');
const chatMessages = document.getElementById('chat-messages');
const composer = document.getElementById('composer');
const inputContainer = document.getElementById('input-container');
const plusButton = document.getElementById('plus-button');
const plusModalBackdrop = document.getElementById('plus-modal-backdrop');
const settingsButton = document.getElementById('settings-button');
const settingsModalBackdrop = document.getElementById('settings-modal-backdrop');
const resetChatButton = document.getElementById('reset-chat-button');
const quickActionButtons = document.querySelectorAll('.action-btn');
const snackbar = document.getElementById('snackbar');
const resetConfirmModalBackdrop = document.getElementById('reset-confirm-modal-backdrop');
const confirmCancelBtn = document.getElementById('confirm-cancel-btn');
const confirmResetBtn = document.getElementById('confirm-reset-btn');
const scrollDownButton = document.getElementById('scroll-down-button');

// ğŸŒŸğŸŒŸğŸŒŸ ë°±ì—”ë“œ ì—”ë“œí¬ì¸íŠ¸ ì„¤ì • (ì‚¬ìš©ì ì£¼ì†Œ ë°˜ì˜) ğŸŒŸğŸŒŸğŸŒŸ
const BACKEND_ENDPOINT = "https://jaewondev.pythonanywhere.com/ask";
const HISTORY_STORAGE_KEY = 'minsugpt_chat_history'; 

// ğŸŒŸğŸŒŸğŸŒŸ ëŒ€í™” ê¸°ë¡ì„ ì €ì¥í•  ë°°ì—´ (ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ì—ì„œ ë¡œë“œë¨) ğŸŒŸğŸŒŸğŸŒŸ
let history = [];

const MAX_ROWS = 6;
const MIN_ROWS = 1;
const FADE_IN_DELAY = 10; // ë¬¸ì¥ë³„ í˜ì´ë“œ ì¸ ë”œë ˆì´ (ms)

let abortController = null;
let isStreaming = false;
let isFadingIn = false;
let autoScrollEnabled = true;
let fadeOutAbortController = null;

const loadingTexts = [
    "ìƒê°í•˜ëŠ” ì¤‘...",
    "ê²€ìƒ‰í•˜ëŠ” ì¤‘...",
    "ë‹µë³€ì„ ì¤€ë¹„í•˜ëŠ” ì¤‘...",
    "ë°ì´í„°ë¥¼ ë¶„ì„í•˜ëŠ” ì¤‘..."
];

let currentLoadingText = loadingTexts[0];
let loadingTextInterval = null;

// ëª¨ë°”ì¼ í™˜ê²½ ê°ì§€
const isMobile = () => /Mobi|Android/i.test(navigator.userAgent);


/**
 * ğŸŒŸ ë¡œë”© í…ìŠ¤íŠ¸ë¥¼ ìˆœí™˜í•˜ë©° ì—…ë°ì´íŠ¸í•©ë‹ˆë‹¤.
 */
function startLoadingTextCycle(indicatorElement) {
    const indicatorText = indicatorElement.querySelector('.thinking-indicator-text');
    let index = 0;
    
    // ì¦‰ì‹œ ì²« í…ìŠ¤íŠ¸ ì„¤ì •
    indicatorText.textContent = loadingTexts[index];
    
    loadingTextInterval = setInterval(() => {
        index = (index + 1) % loadingTexts.length;
        currentLoadingText = loadingTexts[index];
        if (indicatorText) {
            indicatorText.textContent = currentLoadingText;
        }
    }, 2000); // 2ì´ˆë§ˆë‹¤ í…ìŠ¤íŠ¸ ë³€ê²½
}

/**
 * ğŸŒŸ ë¡œë”© í…ìŠ¤íŠ¸ ìˆœí™˜ì„ ë©ˆì¶¥ë‹ˆë‹¤.
 */
function stopLoadingTextCycle() {
    if (loadingTextInterval) {
        clearInterval(loadingTextInterval);
        loadingTextInterval = null;
    }
    currentLoadingText = loadingTexts[0]; // ê¸°ë³¸ í…ìŠ¤íŠ¸ë¡œ ë¦¬ì…‹
}


/**
 * ğŸŒŸ ìŠ¤íŠ¸ë¦¬ë°/ë¡œë”© ìƒíƒœë¥¼ í† ê¸€í•˜ê³  UIë¥¼ ì—…ë°ì´íŠ¸í•©ë‹ˆë‹¤.
 */
function setStreamingState(state, indicatorElement = null) {
    isStreaming = state;
    if (state) {
        // ì „ì†¡ ë²„íŠ¼ ë¹„í™œì„±í™”, ì¤‘ì§€ ë²„íŠ¼ í™œì„±í™”
        sendButton.style.display = 'none';
        stopButton.style.display = 'flex';
        inputField.disabled = true;
        plusButton.classList.add('disabled');
        plusButton.style.pointerEvents = 'none';
        
        // ë¡œë”© í…ìŠ¤íŠ¸ ìˆœí™˜ ì‹œì‘
        if (indicatorElement) {
            startLoadingTextCycle(indicatorElement);
        }
    } else {
        // ì „ì†¡ ë²„íŠ¼ í™œì„±í™”, ì¤‘ì§€ ë²„íŠ¼ ë¹„í™œì„±í™”
        stopButton.style.display = 'none';
        sendButton.style.display = 'flex';
        inputField.disabled = false;
        inputField.focus();
        plusButton.classList.remove('disabled');
        plusButton.style.pointerEvents = 'auto';

        // ë¡œë”© í…ìŠ¤íŠ¸ ìˆœí™˜ ì¤‘ì§€
        stopLoadingTextCycle();
        
        // ì¬ìƒì„± ë²„íŠ¼ ìƒíƒœ ì—…ë°ì´íŠ¸
        updateRegenerateButtons();

        // ì „ì²´ ì‘ë‹µ ì™„ë£Œ í›„ ìŠ¤í¬ë¡¤ ë‹¤ìš´ ë²„íŠ¼ ìƒíƒœ ì—…ë°ì´íŠ¸
        checkScrollPosition();
    }
    toggleSendButton(); // ì…ë ¥ í•„ë“œ ìƒíƒœì— ë”°ë¼ ì „ì†¡ ë²„íŠ¼ í™œì„±í™”/ë¹„í™œì„±í™”
}


/**
 * ğŸŒŸ ìŠ¤ë‚µë°” ì•Œë¦¼ì„ í‘œì‹œí•©ë‹ˆë‹¤.
 */
function showSnackbar(message) {
    snackbar.textContent = message;
    snackbar.classList.add('show');
    // ì´ì „ ì• ë‹ˆë©”ì´ì…˜ì„ ìœ„í•´ ì ì‹œ í´ë˜ìŠ¤ ì œê±° í›„ ë‹¤ì‹œ ì¶”ê°€
    snackbar.style.animation = 'none';
    void snackbar.offsetWidth; // Reflowë¥¼ ê°•ì œí•˜ì—¬ ì• ë‹ˆë©”ì´ì…˜ ì¬ì‹œì‘
    snackbar.style.animation = null;
    
    setTimeout(() => {
        snackbar.classList.remove('show');
    }, 3000); // 3ì´ˆ í›„ ìˆ¨ê¹€
}


/**
 * ğŸŒŸ ìŠ¤í¬ë¡¤ì„ ë§¨ ì•„ë˜ë¡œ ì´ë™í•©ë‹ˆë‹¤.
 */
function scrollToBottom(smooth = true) {
    if (contentWrapper) {
        contentWrapper.scrollTo({
            top: contentWrapper.scrollHeight,
            behavior: smooth ? 'smooth' : 'auto'
        });
        scrollDownButton.classList.remove('visible');
    }
}


/**
 * ğŸŒŸ ìŠ¤í¬ë¡¤ ìœ„ì¹˜ë¥¼ í™•ì¸í•˜ì—¬ ìŠ¤í¬ë¡¤ ë‹¤ìš´ ë²„íŠ¼ì„ í‘œì‹œ/ìˆ¨ê¹€í•©ë‹ˆë‹¤.
 */
function checkScrollPosition() {
    if (!contentWrapper || isStreaming || isFadingIn) return;

    const isScrolledToBottom = contentWrapper.scrollHeight - contentWrapper.clientHeight <= contentWrapper.scrollTop + 10;
    
    if (isScrolledToBottom) {
        scrollDownButton.classList.remove('visible');
        autoScrollEnabled = true; // ìˆ˜ë™ìœ¼ë¡œ ë§¨ ì•„ë˜ì— ìˆìœ¼ë©´ ìë™ ìŠ¤í¬ë¡¤ í™œì„±í™”
    } else {
        scrollDownButton.classList.add('visible');
        // ì‚¬ìš©ìê°€ ìœ„ë¡œ ìŠ¤í¬ë¡¤í•˜ë©´ ìë™ ìŠ¤í¬ë¡¤ ë¹„í™œì„±í™”
        const distanceFromBottom = contentWrapper.scrollHeight - contentWrapper.clientHeight - contentWrapper.scrollTop;
        if (distanceFromBottom > 50) { // 50px ì´ìƒ ë–¨ì–´ì§€ë©´ ë¹„í™œì„±í™”
            autoScrollEnabled = false;
        }
    }
}

// ìŠ¤í¬ë¡¤ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì¶”ê°€
contentWrapper.addEventListener('scroll', () => {
    // ğŸŒŸğŸŒŸğŸŒŸ ìŠ¤í¬ë¡¤ ì¤‘ì—ëŠ” isFadingIn ì²´í¬ë¥¼ ê±´ë„ˆëœë‹ˆë‹¤.
    const isScrolledToBottom = contentWrapper.scrollHeight - contentWrapper.clientHeight <= contentWrapper.scrollTop + 10;
    
    if (isScrolledToBottom) {
        scrollDownButton.classList.remove('visible');
        autoScrollEnabled = true;
    } else if (!isStreaming && !isFadingIn) {
        scrollDownButton.classList.add('visible');
    }
});

function toggleSendButton() {
    if (inputField.value.trim().length > 0 && !isStreaming) {
        sendButton.classList.add('active');
    } else {
        sendButton.classList.remove('active');
    }
}
inputField.addEventListener('input', toggleSendButton);

function autoResizeTextarea() {
    const style = getComputedStyle(inputField);
    const line_height_px = parseFloat(style.getPropertyValue('--line-height-px')) || 22.4;
    const composerPaddingV = 12;
    const inputContainerPaddingV = 8;
    const minInputContainerHeight = parseFloat(style.getPropertyValue('--min-input-container-height')) || 48;
    
    inputField.rows = MIN_ROWS;
    inputField.style.height = 'auto';
    
    let scrollH = inputField.scrollHeight;
    let newRows = Math.round(scrollH / line_height_px);
    newRows = Math.max(MIN_ROWS, Math.min(MAX_ROWS, newRows));
    
    inputField.rows = newRows;
    inputField.style.height = 'auto';

    const finalTextareaHeight = inputField.offsetHeight; 
    const contentHeight = finalTextareaHeight + inputContainerPaddingV; 
    const inputContainerHeight = Math.max(contentHeight, minInputContainerHeight);
    
    inputContainer.style.minHeight = `${inputContainerHeight}px`;
    
    const newComposerHeight = inputContainerHeight + composerPaddingV;
    composer.style.minHeight = `${newComposerHeight}px`;

    // ğŸŒŸ ìŠ¤í¬ë¡¤ ë‹¤ìš´ ë²„íŠ¼ ìœ„ì¹˜ ì¡°ì •
    scrollDownButton.style.bottom = `${newComposerHeight + 10}px`;
    chatMessages.style.paddingBottom = `${newComposerHeight}px`;

    if (autoScrollEnabled) scrollToBottom(false);
}

inputField.addEventListener('input', autoResizeTextarea);

/**
 * ì‚¬ìš©ì ë©”ì‹œì§€ ë²„ë¸”ì„ UIì— ì¶”ê°€í•©ë‹ˆë‹¤.
 */
function appendUserMessage(content, animate = true) {
    const userBubble = document.createElement('div');
    userBubble.className = 'message-bubble user-message';
    userBubble.innerHTML = `<div class="message-text">${content}</div>`;
    chatMessages.appendChild(userBubble);
    if (animate) scrollToBottom(true);
}

/**
 * ğŸŒŸ ì¬ìƒì„± ë²„íŠ¼ë§Œ ë¹„í™œì„±í™” (ì´ì „ ë‹µë³€ì—ë„ ë‹¤ë¥¸ ë²„íŠ¼ì€ ì‘ë™)
 */
function updateRegenerateButtons() {
    const allBotMessages = chatMessages.querySelectorAll('.bot-message');
    const lastBotMessage = allBotMessages[allBotMessages.length - 1];

    allBotMessages.forEach(msg => {
        const regenerateBtn = msg.querySelector('.bot-actions .regenerate');
        if (regenerateBtn) {
            // ëª¨ë“  ì¬ìƒì„± ë²„íŠ¼ ë¹„í™œì„±í™” (disabled í´ë˜ìŠ¤ ì¶”ê°€)
            regenerateBtn.classList.add('disabled');
        }
    });

    if (lastBotMessage) {
        // ê°€ì¥ ë§ˆì§€ë§‰ ë©”ì‹œì§€ë§Œ ì¬ìƒì„± ë²„íŠ¼ í™œì„±í™”
        const lastRegenerateBtn = lastBotMessage.querySelector('.bot-actions .regenerate');
        if (lastRegenerateBtn) {
            lastRegenerateBtn.classList.remove('disabled');
        }
    }
}

/**
 * ğŸŒŸ ì¢‹ì•„ìš”, ì‹«ì–´ìš”, ë³µì‚¬, ê³µìœ , ë‹¤ì‹œ ë‹µë³€ ì•¡ì…˜ ë²„íŠ¼ì„ ë§Œë“­ë‹ˆë‹¤.
 */
function createBotActions(content, messageIndex, feedbackStatus = null) {
    const actionsContainer = document.createElement('div');
    actionsContainer.className = 'bot-actions';

    const createActionButton = (actionClass, title, iconName, iconOutlineName) => {
        const button = document.createElement('button');
        button.className = `bot-action-btn ${actionClass}`;
        button.title = title;
        button.innerHTML = `<span class="material-symbols-rounded">${iconName || iconOutlineName}</span>`;
        
        // ì•„ì´ì½˜ ì±„ìš°ê¸°/ë¹„ìš°ê¸° ìƒíƒœ ì´ˆê¸°í™”
        if (actionClass === 'like' && feedbackStatus === 'like') {
            button.classList.add('selected');
        } else if (actionClass === 'dislike' && feedbackStatus === 'dislike') {
            button.classList.add('selected');
        }
        
        return button;
    };

    // 1. ì¢‹ì•„ìš”
    const likeBtn = createActionButton('like', 'ì¢‹ì•„ìš”', 'thumb_up', 'thumb_up');
    
    // 2. ì‹«ì–´ìš”
    const dislikeBtn = createActionButton('dislike', 'ì‹«ì–´ìš”', 'thumb_down', 'thumb_down');

    // 3. ë³µì‚¬
    const copyBtn = createActionButton('copy', 'ë³µì‚¬', null, 'content_copy');
    copyBtn.addEventListener('click', () => {
        // ë§ˆí¬ë‹¤ìš´ ë¬¸ë²•ì„ ì œê±°í•˜ê³  ìˆœìˆ˜ í…ìŠ¤íŠ¸ë§Œ ë³µì‚¬ (HTML ì½”ë“œë¥¼ ê°€ì ¸ì™€ì„œ ì²˜ë¦¬)
        const tempDiv = document.createElement('div');
        tempDiv.innerHTML = renderMarkdown(content);
        const textToCopy = tempDiv.textContent || tempDiv.innerText || content;
        
        navigator.clipboard.writeText(textToCopy.trim()).then(() => {
            showSnackbar('ë‹µë³€ì´ í´ë¦½ë³´ë“œì— ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤.');
        }).catch(err => {
            console.error('ë³µì‚¬ ì‹¤íŒ¨: ', err);
            showSnackbar('ë³µì‚¬ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
        });
    });

    // 4. ê³µìœ 
    const shareBtn = createActionButton('share', 'ê³µìœ ', null, 'share');
    shareBtn.addEventListener('click', () => {
        if (navigator.share) {
            navigator.share({
                title: 'MinsuGPT ë‹µë³€',
                text: content,
                url: window.location.href,
            }).then(() => {
                console.log('ê³µìœ  ì„±ê³µ');
            }).catch((error) => {
                console.error('ê³µìœ  ì‹¤íŒ¨: ', error);
                showSnackbar('ê³µìœ ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
            });
        } else {
            navigator.clipboard.writeText(content).then(() => {
                showSnackbar('ê³µìœ  ê¸°ëŠ¥ì´ ì—†ì–´ ë©”ì‹œì§€ë¥¼ ë³µì‚¬í–ˆìŠµë‹ˆë‹¤.');
            }).catch(err => {
                console.error('ë³µì‚¬ ì‹¤íŒ¨: ', err);
                showSnackbar('ê³µìœ  ë° ë³µì‚¬ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
            });
        }
    });
    
    // 5. ë‹¤ì‹œ ë‹µë³€ ë²„íŠ¼ (Regenerate)
    const regenerateBtn = createActionButton('regenerate', 'ë‹¤ì‹œ ë‹µë³€ë°›ê¸°', null, 'autorenew');
    regenerateBtn.addEventListener('click', (e) => {
        // ğŸŒŸğŸŒŸğŸŒŸ ê°€ì¥ ë§ˆì§€ë§‰ ë©”ì‹œì§€ì¸ì§€ í™•ì¸ ğŸŒŸğŸŒŸğŸŒŸ
        if (!regenerateBtn.classList.contains('disabled')) {
            handleRegenerate(messageIndex);
        } else {
            showSnackbar('ê°€ì¥ ìµœì‹  ë‹µë³€ë§Œ ì¬ìƒì„±í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.');
        }
    });

    // ì¢‹ì•„ìš”/ì‹«ì–´ìš” ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
    const toggleFeedback = (action, otherAction, index) => {
        const currentMessage = history[index];
        if (!currentMessage || currentMessage.role !== 'model') return;

        const newFeedback = currentMessage.feedback === action ? null : action;
        currentMessage.feedback = newFeedback;
        history[index].feedback = newFeedback;
        saveChatHistory();

        // UI ì—…ë°ì´íŠ¸
        const btn = document.querySelector(`.bot-message[data-index="${index}"] .bot-action-btn.${action}`);
        const otherBtn = document.querySelector(`.bot-message[data-index="${index}"] .bot-action-btn.${otherAction}`);

        if (newFeedback) {
            btn.classList.add('selected');
            if (otherBtn) otherBtn.classList.remove('selected');
        } else {
            btn.classList.remove('selected');
        }
    };
    
    likeBtn.addEventListener('click', () => toggleFeedback('like', 'dislike', messageIndex));
    dislikeBtn.addEventListener('click', () => toggleFeedback('dislike', 'like', messageIndex));


    actionsContainer.appendChild(likeBtn);
    actionsContainer.appendChild(dislikeBtn);
    actionsContainer.appendChild(copyBtn);
    actionsContainer.appendChild(shareBtn);
    actionsContainer.appendChild(regenerateBtn);
    
    // ì´ˆê¸° ìƒíƒœì—ì„œ ê°€ì¥ ë§ˆì§€ë§‰ ë©”ì‹œì§€ê°€ ì•„ë‹ˆë©´ ì¬ìƒì„±ë§Œ ë¹„í™œì„±í™” ìƒíƒœ ë¶€ì—¬
    if (messageIndex !== history.length - 1 && history.filter(msg => msg.role === 'model').length > 0) {
        regenerateBtn.classList.add('disabled');
    }

    return actionsContainer;
}

/**
 * ğŸŒŸ ì¬ìƒì„± ë¡œì§ ì²˜ë¦¬
 */
function handleRegenerate(messageIndex) {
    if (isStreaming || isFadingIn) {
        showSnackbar('í˜„ì¬ ë‹µë³€ ìƒì„± ì¤‘ì…ë‹ˆë‹¤. ì ì‹œ ê¸°ë‹¤ë ¤ ì£¼ì„¸ìš”.');
        return;
    }
    
    // 1. ë§ˆì§€ë§‰ ì‚¬ìš©ì ë©”ì‹œì§€ë¥¼ ì°¾ìŠµë‹ˆë‹¤.
    let lastUserMessage = null;
    let userMessageIndex = -1;
    for (let i = messageIndex; i >= 0; i--) {
        if (history[i].role === 'user') {
            lastUserMessage = history[i].content;
            userMessageIndex = i;
            break;
        }
    }
    
    if (!lastUserMessage) {
        showSnackbar('ì¬ìƒì„±í•  ì´ì „ ì‚¬ìš©ì ë©”ì‹œì§€ê°€ ì—†ìŠµë‹ˆë‹¤.');
        return;
    }

    // 2. ì¬ìƒì„±í•  ë©”ì‹œì§€ì™€ ê·¸ì— ë”°ë¥¸ ì‚¬ìš©ì ë©”ì‹œì§€ë¥¼ ê¸°ë¡ì—ì„œ ì œê±°í•©ë‹ˆë‹¤.
    // (í˜„ì¬ëŠ” í•­ìƒ ë§ˆì§€ë§‰ ëª¨ë¸ ë©”ì‹œì§€ì™€ ê·¸ì— ì§ì§€ì–´ì§„ ì‚¬ìš©ì ë©”ì‹œì§€ë¥¼ ì œê±°)
    
    // 2-1. ì´ì „ ë‹µë³€ ê´€ë ¨ UI ì œê±° (ë§ˆì§€ë§‰ ë´‡ ë©”ì‹œì§€ì™€ ê·¸ì— ë”°ë¥¸ 'ë‹µë³€ ì¤‘ì§€ë¨' í…ìŠ¤íŠ¸ ì œê±°)
    const lastBotMessageElement = chatMessages.lastElementChild;
    if (lastBotMessageElement && lastBotMessageElement.classList.contains('bot-message')) {
        const nextSibling = lastBotMessageElement.nextElementSibling;
        if (nextSibling && nextSibling.classList.contains('stop-message')) {
            nextSibling.remove(); 
        }
        lastBotMessageElement.remove(); 
    }
    
    // 2-2. ì‹¤ì œ ê¸°ë¡ì—ì„œ ë´‡ ë©”ì‹œì§€ ì œê±°
    if (history.length > 0 && history[history.length - 1].role === 'model') {
        history.pop();
    }
    
    // 2-3. ì‹¤ì œ ê¸°ë¡ì—ì„œ ì‚¬ìš©ì ë©”ì‹œì§€ ì œê±° (sendë¡œì§ì—ì„œ ë‹¤ì‹œ ì¶”ê°€í•  ê²ƒì´ë¯€ë¡œ)
    let messageToSend = '';
    if (history.length > 0 && history[history.length - 1].role === 'user') {
        messageToSend = history[history.length - 1].content;
        history.pop(); // ë‹¤ì‹œ ë³´ë‚¼ ë©”ì‹œì§€ë¥¼ ê¸°ë¡ì—ì„œ ì œê±°
        
        // 2-4. ì‚¬ìš©ì ë©”ì‹œì§€ UI ì œê±° (ë§ˆì§€ë§‰ ì‚¬ìš©ì ë©”ì‹œì§€ ë²„ë¸”)
        const lastUserMessageElement = chatMessages.lastElementChild;
        if (lastUserMessageElement && lastUserMessageElement.classList.contains('user-message')) {
            lastUserMessageElement.remove();
        }
    }

    // 3. ë‹¤ì‹œ ë©”ì‹œì§€ ì „ì†¡
    if (messageToSend) {
        sendMessage(messageToSend);
    } else {
        showSnackbar('ì¬ìƒì„±í•  ë©”ì‹œì§€ ì»¨í…ìŠ¤íŠ¸ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
    }
}

/**
 * ğŸ’¡ ìƒê°í•˜ëŠ” ì¤‘... UIë¥¼ í‘œì‹œí•˜ê³  ë´‡ ë©”ì‹œì§€ ì»¨í…Œì´ë„ˆë¥¼ ìƒì„±í•©ë‹ˆë‹¤.
 */
function startStreamingUI() {
    // ì´ì „ ë¡œë”© í…ìŠ¤íŠ¸ë¥¼ ìˆ¨ê¹ë‹ˆë‹¤ (ì¬ìƒì„± ì‹œ ì´ì „ ë‹µë³€ì´ ë‚¨ì•„ìˆëŠ” ê²½ìš° ëŒ€ë¹„)
    const oldIndicator = document.getElementById('thinking-indicator');
    if (oldIndicator) oldIndicator.style.display = 'none';

    // ë´‡ ë©”ì‹œì§€ ì»¨í…Œì´ë„ˆ ìƒì„±
    const botMessageContainer = document.createElement('div');
    botMessageContainer.className = 'bot-message';
    botMessageContainer.setAttribute('data-index', history.length); 

    // ğŸ’¡ ìƒê°í•˜ëŠ” ì¤‘... í‘œì‹œê¸°
    const indicatorContainer = document.createElement('div');
    indicatorContainer.id = 'thinking-indicator';
    indicatorContainer.className = 'thinking-indicator';
    
    const indicatorText = document.createElement('span');
    indicatorText.className = 'thinking-indicator-text';
    indicatorText.textContent = currentLoadingText;
    
    // ğŸŒŸ ìŠ¤í”¼ë„ˆ ì—˜ë¦¬ë¨¼íŠ¸ ì¶”ê°€
    const spinner = document.createElement('div');
    spinner.className = 'loading-spinner';
    
    indicatorContainer.appendChild(indicatorText);
    indicatorContainer.appendChild(spinner);
    
    // ğŸŒŸ ìŠ¤íŠ¸ë¦¬ë°ë˜ëŠ” í…ìŠ¤íŠ¸ê°€ ë“¤ì–´ê°ˆ ì»¨í…Œì´ë„ˆ
    const streamingBlock = document.createElement('div');
    streamingBlock.className = 'streaming-block';
    
    botMessageContainer.appendChild(indicatorContainer);
    botMessageContainer.appendChild(streamingBlock);
    
    chatMessages.appendChild(botMessageContainer);
    
    if (autoScrollEnabled) scrollToBottom(true);
    
    // ğŸŒŸğŸŒŸğŸŒŸ ìŠ¤íŠ¸ë¦¬ë° ìƒíƒœ ì‹œì‘
    setStreamingState(true, indicatorContainer);

    return { 
        botMessageElement: botMessageContainer, 
        indicatorElement: indicatorContainer, 
        streamingBlockElement: streamingBlock 
    };
}


/**
 * ğŸŒŸ ë¡œë”© ì™„ë£Œ í›„ ë´‡ ë©”ì‹œì§€ì— ì•¡ì…˜ ë²„íŠ¼ì„ ì¶”ê°€í•©ë‹ˆë‹¤.
 */
function appendBotMessage(content, feedbackStatus, animate = true) {
    const botMessageContainer = document.createElement('div');
    botMessageContainer.className = 'bot-message';
    const messageIndex = history.length - 1;
    botMessageContainer.setAttribute('data-index', messageIndex);

    const streamingBlock = document.createElement('div');
    streamingBlock.className = 'streaming-block';
    botMessageContainer.appendChild(streamingBlock);
    
    chatMessages.appendChild(botMessageContainer);
    
    // ğŸŒŸğŸŒŸğŸŒŸ ë¬¸ì¥ë³„ í˜ì´ë“œì¸ ì‹œì‘
    if (animate) {
        // ìë™ ìŠ¤í¬ë¡¤ ì¼œê¸°
        autoScrollEnabled = true;
        scrollDownButton.classList.remove('visible');
        
        sentenceFadeInEffect(streamingBlock, content, messageIndex).then(() => {
            // í˜ì´ë“œì¸ ì™„ë£Œ í›„ ì•¡ì…˜ ë²„íŠ¼ ì¶”ê°€ ë° ì¬ìƒì„± ë²„íŠ¼ ìƒíƒœ ì—…ë°ì´íŠ¸
            const actionsContainer = createBotActions(content, messageIndex, feedbackStatus);
            botMessageContainer.appendChild(actionsContainer);
            updateRegenerateButtons(); 
            // ìµœì‹  ë©”ì‹œì§€ í™œì„±í™”
            if (autoScrollEnabled) scrollToBottom(true);
        });
    } else {
        // ê³¼ê±° ê¸°ë¡ ë¡œë“œ ì‹œëŠ” ì¦‰ì‹œ í‘œì‹œ
        streamingBlock.innerHTML = renderMarkdown(content);
        const actionsContainer = createBotActions(content, messageIndex, feedbackStatus);
        botMessageContainer.appendChild(actionsContainer);
        updateRegenerateButtons(); 
    }
}


/**
 * ğŸŒŸ Markdownì„ HTMLë¡œ ë³€í™˜í•˜ëŠ” í•¨ìˆ˜
 * (ê°„ì†Œí™”ëœ ë³€í™˜, ì‹¤ì œë¡œëŠ” ë¼ì´ë¸ŒëŸ¬ë¦¬ ì‚¬ìš© ê¶Œì¥)
 * @param {string} markdownText - ë³€í™˜í•  ë§ˆí¬ë‹¤ìš´ í…ìŠ¤íŠ¸
 * @param {boolean} wrapSentences - ë¬¸ì¥ë³„ í˜ì´ë“œì¸ì„ ìœ„í•´ <span class="sentence">ìœ¼ë¡œ ê°ìŒ€ì§€ ì—¬ë¶€
 * @returns {string} HTML ë¬¸ìì—´
 */
function renderMarkdown(markdownText, wrapSentences = false) {
    let html = markdownText || '';

    // 1. ì½”ë“œ ë¸”ë¡(` ``` `) ì²˜ë¦¬: <pre><code>...</code></pre>ë¡œ ë˜í•‘
    html = html.replace(/```(\w+)?\n([\s\S]*?)```/g, (match, lang, code) => {
        const language = lang || 'plaintext';
        // HTML ì´ìŠ¤ì¼€ì´í”„: <, >, & ë“±ì„ &lt;, &gt;, &amp;ë¡œ
        const escapedCode = code.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
        return `<pre><code class="language-${language}">${escapedCode.trim()}</code></pre>`;
    });

    // 2. í—¤ë” ì²˜ë¦¬ (## -> <h2> ë“±)
    html = html.replace(/^### (.*$)/gim, '<h3>$1</h3>');
    html = html.replace(/^## (.*$)/gim, '<h2>$1</h2>');
    html = html.replace(/^# (.*$)/gim, '<h1>$1</h1>');

    // 3. ëª©ë¡ ì²˜ë¦¬ (*, - -> <ul><li>)
    // ê°„ë‹¨í•œ ëª©ë¡ë§Œ ì²˜ë¦¬ (ì¤„ë°”ê¿ˆì´ í•„ìš”í•œ ê²½ìš°)
    html = html.replace(/^\s*[\*-] (.*)/gm, '<li>$1</li>');
    if (html.includes('<li>')) {
        // ì—°ì†ëœ <li>ë¥¼ <ul>ë¡œ ë˜í•‘
        html = html.replace(/(<li>[\s\S]*?<\/li>)/g, '<ul>$1</ul>');
        html = html.replace(/<\/ul>\s*<ul>/g, ''); // ì—°ì†ëœ <ul> íƒœê·¸ ë³‘í•©
    }
    
    // 4. ë³¼ë“œ ì²˜ë¦¬ (**text** -> <strong>text</strong>)
    html = html.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
    
    // 5. ë¬¸ì¥ë³„ ë˜í•‘ (í˜ì´ë“œì¸ íš¨ê³¼ë¥¼ ìœ„í•´)
    if (wrapSentences) {
        // ì •ê·œ í‘œí˜„ì‹ì„ ì‚¬ìš©í•˜ì—¬ ë¬¸ì¥ ë‹¨ìœ„ë¡œ ë¶„ë¦¬ (ë§ˆì¹¨í‘œ, ë¬¼ìŒí‘œ, ëŠë‚Œí‘œ, ëª©ë¡, ì½”ë“œë¸”ë¡ ê¸°ì¤€)
        // ì½”ë“œ ë¸”ë¡ê³¼ í—¤ë”ëŠ” ë¶„ë¦¬í•˜ì§€ ì•Šê³  ê·¸ëŒ€ë¡œ ë‘ 
        // <pre>ë‚˜ <h2> ë“±ì˜ íƒœê·¸ë¥¼ ê¸°ì¤€ìœ¼ë¡œ í…ìŠ¤íŠ¸ë¥¼ ë¶„í• í•˜ì—¬, íƒœê·¸ ë‚´ë¶€/ì „í›„ëŠ” ë˜í•‘í•˜ì§€ ì•ŠìŒ
        const parts = html.split(/(<pre>[\s\S]*?<\/pre>|<h[1-6]>.*?<\/h[1-6]>)/);
        let wrappedHtml = '';

        for (const part of parts) {
            // ì½”ë“œ ë¸”ë¡ì´ë‚˜ í—¤ë” ë¶€ë¶„ì€ ë˜í•‘í•˜ì§€ ì•ŠìŒ
            if (part.match(/<pre>/) || part.match(/<h[1-6]>/)) {
                wrappedHtml += part;
            } else {
                // ì¼ë°˜ í…ìŠ¤íŠ¸ ë¬¸ì¥ê³¼ ë¬¸ì¥ ë¶€í˜¸ë¥¼ í¬í•¨í•˜ì—¬ ë˜í•‘
                // ì¤„ë°”ê¿ˆì€ <br>ë¡œ ë³€í™˜
                const sentences = part.match(/[^.!?\n]+[.!?\n]+/g) || [part];
                sentences.forEach(sentence => {
                    wrappedHtml += `<span class="sentence">${sentence.replace(/(?<!<br>)\n/g, '<br>')}</span>`;
                });
            }
        }
        html = wrappedHtml;
    }
    
    // 6. ë‹¨ì¼ ì¤„ë°”ê¿ˆì„ <br>ë¡œ ë³€í™˜ (wrapSentencesê°€ falseì¼ ë•Œë§Œ ì‹¤í–‰)
    if (!wrapSentences) {
         html = html.replace(/(?<!<br>)\n/g, '<br>');
    }

    return html;
}


/**
 * ìŠ¤íŠ¸ë¦¬ë°ë˜ëŠ” ì „ì²´ í…ìŠ¤íŠ¸ë¥¼ ê¸°ë°˜ìœ¼ë¡œ ë‚´ìš©ì„ ë®ì–´ì”ë‹ˆë‹¤. (ìŠ¤íŠ¸ë¦¬ë° ì¤‘ì—ë§Œ ì‚¬ìš©)
 */
function updateStreamingDisplay(rawResponse, streamingElement) {
    // ìŠ¤íŠ¸ë¦¬ë° ì¤‘ì—ëŠ” íƒ€ì´í•‘ íš¨ê³¼ ì—†ì´ ì¦‰ì‹œ ì—…ë°ì´íŠ¸
    streamingElement.innerHTML = renderMarkdown(rawResponse);
    if (autoScrollEnabled) scrollToBottom(false);
}


/**
 * ğŸŒŸğŸŒŸğŸŒŸ ë¬¸ì¥ë³„ í˜ì´ë“œ ì¸ íš¨ê³¼ í•¨ìˆ˜ (ìŠ¤í¬ë¡¤ ìœ ì§€ ë¡œì§ ì¶”ê°€) ğŸŒŸğŸŒŸğŸŒŸ
 */
function sentenceFadeInEffect(element, rawText, messageIndex) {
    return new Promise(resolve => {
        isFadingIn = true;
        
        // í…ìŠ¤íŠ¸ë¥¼ ë§ˆí¬ë‹¤ìš´ ë³€í™˜ ë° ë¬¸ì¥ ë˜í•‘
        element.innerHTML = renderMarkdown(rawText, true);
        const sentences = element.querySelectorAll('.sentence');
        let index = 0;
        const delay = FADE_IN_DELAY;

        // ì¤‘ì§€ ë²„íŠ¼ì„ ëˆŒë €ì„ ë•Œ ì• ë‹ˆë©”ì´ì…˜ì„ ë¹ ë¥´ê²Œ ì¢…ë£Œí•˜ëŠ” í•¨ìˆ˜
        const abortFadeIn = () => {
            isFadingIn = false;
            sentences.forEach(s => s.classList.add('visible'));
            if (autoScrollEnabled) scrollToBottom(true);
            resolve();
        };
        
        // ì¤‘ì§€ ë¡œì§ì—ì„œ ì°¸ì¡°í•  ìˆ˜ ìˆë„ë¡ ì „ì—­ ë³€ìˆ˜ì— ì €ì¥
        fadeOutAbortController = { abort: abortFadeIn };


        function showNextSentence() {
            if (!isFadingIn) {
                return;
            }

            if (index < sentences.length) {
                const currentSentence = sentences[index];
                currentSentence.classList.add('visible');

                // ğŸŒŸ í˜„ì¬ ë¬¸ì¥ì´ ë³´ì´ì§€ ì•Šìœ¼ë©´ ìŠ¤í¬ë¡¤
                if (autoScrollEnabled) {
                    const rect = currentSentence.getBoundingClientRect();
                    const containerRect = contentWrapper.getBoundingClientRect();

                    if (rect.bottom > containerRect.bottom || rect.top < containerRect.top) {
                         // í˜„ì¬ ë¬¸ì¥ì´ ë·°í¬íŠ¸ ì•„ë˜ì— ìˆê±°ë‚˜ ë„ˆë¬´ ìœ„ì— ìˆì–´ ì•ˆ ë³´ì´ë©´ ìŠ¤í¬ë¡¤
                        scrollToBottom(false); 
                    }
                }

                index++;
                setTimeout(showNextSentence, delay);
            } else {
                // ëª¨ë“  ë¬¸ì¥ í‘œì‹œ ì™„ë£Œ
                isFadingIn = false;
                fadeOutAbortController = null;
                resolve();
            }
        }

        // ì§€ì—° ì‹œê°„ í›„ ì‹œì‘ (ì‹œì‘ ì‹œì ì— ë¡œë”© í‘œì‹œê¸°ê°€ ì‚¬ë¼ì§€ë„ë¡)
        setTimeout(() => {
            const indicator = element.parentElement.querySelector('#thinking-indicator');
            if (indicator) indicator.style.display = 'none';
            if (isFadingIn) {
                 showNextSentence();
            } else {
                 resolve();
            }
        }, 100); // ë¡œë”© í‘œì‹œê¸° ì œê±° í›„ ì ì‹œ ì§€ì—°
    });
}


/**
 * ğŸŒŸ ë‹µë³€ ìŠ¤íŠ¸ë¦¬ë°ì„ ì¤‘ì§€í•©ë‹ˆë‹¤.
 */
function stopResponse() {
    if (!isStreaming && !isFadingIn) return;

    // 1. í˜ì´ë“œì¸ íš¨ê³¼ ì¤‘ì§€
    if (isFadingIn && fadeOutAbortController) {
        fadeOutAbortController.abort();
    }
    
    // 2. ìŠ¤íŠ¸ë¦¬ë° ìš”ì²­ ì¤‘ì§€
    if (abortController) {
        abortController.abort();
        abortController = null;
    } 
    
    // 3. ìŠ¤íŠ¸ë¦¬ë° ì¤‘ì¼ ë•Œ ì¤‘ì§€
    if (abortController) { 
        // abortControllerê°€ nullì´ ì•„ë‹ ê²½ìš° (fetchê°€ ì§„í–‰ ì¤‘ì´ì—ˆìŒ)
        const lastBotMessageElement = chatMessages.lastElementChild;
        if (lastBotMessageElement) {
            const indicator = lastBotMessageElement.querySelector('#thinking-indicator');
            const streamingBlock = lastBotMessageElement.querySelector('.streaming-block');
            
            // (A) ë¡œë”© ì¤‘ (ì¸ë””ì¼€ì´í„° í‘œì‹œ ì¤‘)ì— ì¤‘ì§€ëœ ê²½ìš°
            if (indicator && indicator.style.display !== 'none') {
                 // ì‚¬ìš©ì ë©”ì‹œì§€ë§Œ ì œê±°í•˜ê³ , ë´‡ ë©”ì‹œì§€ ì»¨í…Œì´ë„ˆë¥¼ ì œê±°
                lastBotMessageElement.remove();
                if (history.length > 0 && history[history.length - 1].role === 'user') {
                    history.pop();
                }
            }
            // (B) í…ìŠ¤íŠ¸ë¥¼ ì¼ë¶€ ë°›ì€ í›„ ì¤‘ì§€ëœ ê²½ìš°
            else if (streamingBlock && fullResponse.trim().length > 0) {
                // ë¶ˆì™„ì „í•œ ì‘ë‹µ ê¸°ë¡
                history.push({ role: 'model', content: fullResponse, feedback: null });
                saveChatHistory();
                
                // ì•¡ì…˜ ë²„íŠ¼ ì¶”ê°€
                const actionContainer = createBotActions(fullResponse, history.length - 1);
                lastBotMessageElement.appendChild(actionContainer);
                updateRegenerateButtons();
                
                // ì±„íŒ…ì°½ì— "ë‹µë³€ ì¤‘ì§€ë¨." ë©”ì‹œì§€ ì¶”ê°€
                const stopText = document.createElement('div');
                stopText.className = 'stop-message';
                stopText.textContent = "ë‹µë³€ ì¤‘ì§€ë¨.";
                lastBotMessageElement.insertAdjacentElement('afterend', stopText);

            } 
            // (C) ì•„ë¬´ê²ƒë„ ë°›ì§€ ëª»í•˜ê³  ì¤‘ì§€ëœ ê²½ìš°
            else if (lastBotMessageElement && fullResponse.trim().length === 0) {
                lastBotMessageElement.remove();
                if (history.length > 0 && history[history.length - 1].role === 'user') {
                    history.pop();
                }
            }
        }
    }
    
    setStreamingState(false);
    scrollToBottom(true);
}
stopButton.addEventListener('click', stopResponse);

// ë©”ì‹œì§€ ì „ì†¡ ì²˜ë¦¬
let fullResponse = "";
async function sendMessage(userMessageOverride = null) {
    const userMessage = userMessageOverride !== null ? userMessageOverride : inputField.value.trim();

    if (userMessage === "" || isStreaming || isFadingIn) return;

    // 1. UI ì—…ë°ì´íŠ¸ ë° ê¸°ë¡ ì¶”ê°€
    // í…ìŠ¤íŠ¸ë¥¼ ì…ë ¥í–ˆë‹¤ë©´, ì…ë ¥ í•„ë“œ ì´ˆê¸°í™” ë° ìë™ í¬ê¸° ì¡°ì ˆ
    if (userMessageOverride === null) {
        inputField.value = '';
        autoResizeTextarea();
    }
    
    appendUserMessage(userMessage, true);
    history.push({ role: "user", content: userMessage });
    saveChatHistory();

    // 2. ìŠ¤íŠ¸ë¦¬ë° UI ì‹œì‘
    const { indicatorElement, streamingBlockElement, botMessageElement } = startStreamingUI();

    fullResponse = "";
    let buffer = "";
    abortController = new AbortController();
    const signal = abortController.signal;

    try {
        const response = await fetch(BACKEND_ENDPOINT, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                message: userMessage,
                // ğŸŒŸğŸŒŸğŸŒŸ historyë¥¼ ì „ì†¡í•  ë•Œ, ì‹œìŠ¤í…œ ì»¨í…ìŠ¤íŠ¸ë„ í•¨ê»˜ ì „ì†¡í•˜ì—¬ ëª¨ë¸ì´ ìŠì§€ ì•Šë„ë¡ í•¨ ğŸŒŸğŸŒŸğŸŒŸ
                history: [...history],
            }),
            signal: signal
        });

        if (!response.ok) {
             startStreamingUI(indicatorElement); 
             let errorMessage = `HTTP Error: ${response.status} ${response.statusText}`;
             
             if (response.status === 429) {
                 errorMessage = "âš ï¸ ìš”ì²­ ì†ë„ ì œí•œ ì´ˆê³¼: ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ ì£¼ì„¸ìš”.";
             } else if (response.status === 400) {
                 errorMessage = "âš ï¸ ì˜ëª»ëœ ìš”ì²­: ì…ë ¥ ë©”ì‹œì§€ ê¸¸ì´ ë“±ì„ í™•ì¸í•´ ì£¼ì„¸ìš”.";
             } else if (response.status >= 500) {
                 errorMessage = `âš ï¸ ì„œë²„ ì˜¤ë¥˜: ë°±ì—”ë“œì—ì„œ ë¬¸ì œê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. (HTTP ${response.status})`;
             }
             
             streamingBlockElement.innerHTML = `<p style="color:red;">${errorMessage}</p>`;
             setStreamingState(false);
             
             // ì˜¤ë¥˜ ë°œìƒ ì‹œ historyì—ì„œ ë§ˆì§€ë§‰ ì‚¬ìš©ì ë©”ì‹œì§€ ì œê±°
             if (history.length > 0 && history[history.length - 1].role === 'user') {
                 history.pop();
                 saveChatHistory();
             }
             updateRegenerateButtons(); 
             
             // ì˜¤ë¥˜ í›„ ë§¨ ì•„ë˜ë¡œ ìŠ¤í¬ë¡¤
             scrollToBottom(true);
             return;
        }

        const reader = response.body.getReader();
        const decoder = new TextDecoder('utf-8');

        while (true) {
            const { done, value } = await reader.read();
            if (done) {
                break;
            }

            buffer += decoder.decode(value, { stream: true });
            
            // í•œ ì¤„ì”© ì²˜ë¦¬
            const parts = buffer.split('\n');
            buffer = parts.pop(); // ë¶ˆì™„ì „í•œ ë§ˆì§€ë§‰ ë¶€ë¶„ì€ ë²„í¼ì— ìœ ì§€

            for (const part of parts) {
                const cleanPart = part;
                
                if (cleanPart.trim() === "[DONE]") {
                    fullResponse += buffer; // [DONE] ì•ì— ë‚¨ì€ ë²„í¼ ì¶”ê°€
                    // ğŸŒŸğŸŒŸğŸŒŸ ìŠ¤íŠ¸ë¦¬ë° ì¢…ë£Œ í›„ ìµœì¢… í˜ì´ë“œì¸ íš¨ê³¼ ì ìš© ğŸŒŸğŸŒŸğŸŒŸ
                    setStreamingState(false);

                    // ê¸°ë¡ì— ì¶”ê°€
                    history.push({ role: "model", content: fullResponse, feedback: null });
                    saveChatHistory();
                    
                    // ê¸°ì¡´ ë©”ì‹œì§€ UI ì œê±°
                    botMessageElement.remove();
                    
                    // ìµœì¢… ë©”ì‹œì§€ UI ì¶”ê°€ ë° í˜ì´ë“œì¸ ì‹œì‘
                    appendBotMessage(fullResponse, null, true);
                    return; // ì™„ë£Œ ì‹œ ë£¨í”„ ì¢…ë£Œ
                } else if (cleanPart) {
                    fullResponse += cleanPart;
                    updateStreamingDisplay(fullResponse, streamingBlockElement);
                }
            }
        }

        // ìŠ¤íŠ¸ë¦¬ë°ì´ [DONE] ì—†ì´ ì¢…ë£Œëœ ê²½ìš° (ì™„ì „í•œ ì‘ë‹µì´ ì•„ë‹ ê°€ëŠ¥ì„± ë†’ìŒ)
        if (fullResponse.trim().length > 0) {
            // ê¸°ë¡ì— ì¶”ê°€
            history.push({ role: "model", content: fullResponse, feedback: null });
            saveChatHistory();
            
            // ê¸°ì¡´ ë©”ì‹œì§€ UI ì œê±°
            botMessageElement.remove();
            
            // ìµœì¢… ë©”ì‹œì§€ UI ì¶”ê°€ ë° í˜ì´ë“œì¸ ì‹œì‘
            appendBotMessage(fullResponse, null, true);
        } else {
             // ì•„ë¬´ ì‘ë‹µë„ ë°›ì§€ ëª»í•œ ê²½ìš° (API ì˜¤ë¥˜)
             streamingBlockElement.innerHTML = `<p style="color:red;">âš ï¸ ì‘ë‹µì„ ë°›ì§€ ëª»í–ˆìŠµë‹ˆë‹¤. ë°±ì—”ë“œ ìƒíƒœë¥¼ í™•ì¸í•´ ì£¼ì„¸ìš”.</p>`;
             // ì‚¬ìš©ì ë©”ì‹œì§€ ê¸°ë¡ì—ì„œ ì œê±°
             if (history.length > 0 && history[history.length - 1].role === 'user') {
                 history.pop();
                 saveChatHistory();
             }
        }

        setStreamingState(false);
        updateRegenerateButtons();
        
    } catch (error) {
        if (error.name === 'AbortError') {
            console.log('Fetch aborted by user or cleanup triggered.');
            // ì´ë¯¸ stopResponseì—ì„œ ì²˜ë¦¬ë¨
        } else {
            console.error('Fetch/Streaming Error:', error);
            const errorMsg = `âš ï¸ í†µì‹  ì˜¤ë¥˜: ì„œë²„ì— ì—°ê²°í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤. CORS ì„¤ì • ë˜ëŠ” ì£¼ì†Œë¥¼ í™•ì¸í•´ ì£¼ì„¸ìš”. (Error: ${error.message})`;
             
            startStreamingUI(indicatorElement); 
            streamingBlockElement.innerHTML = `<p style="color:red;">${errorMsg}</p>`;
            
            // ì˜¤ë¥˜ ë°œìƒ ì‹œ historyì—ì„œ ë§ˆì§€ë§‰ ì‚¬ìš©ì ë©”ì‹œì§€ ì œê±° (ì™„ì „í•œ ì‘ë‹µ ì‹¤íŒ¨)
            if (history.length > 0 && history[history.length - 1].role === 'user') {
                 history.pop();
                 saveChatHistory();
            }
            updateRegenerateButtons();
        }
        
        setStreamingState(false);
        scrollToBottom(true);
    } finally {
        // cleanup
        abortController = null;
    }
}

// Enter í‚¤ ì´ë²¤íŠ¸
inputField.addEventListener('keypress', (e) => {
    if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        sendMessage();
    }
});

// ì „ì†¡ ë²„íŠ¼ í´ë¦­ ì´ë²¤íŠ¸
sendButton.addEventListener('click', (e) => {
    e.preventDefault();
    sendMessage();
});


/**
 * ğŸŒŸ ì±— ê¸°ë¡ ë¡œë“œ ë° UI ë³µì›
 */
function loadChatHistory() {
    const storedHistory = localStorage.getItem(HISTORY_STORAGE_KEY);
    if (storedHistory) {
        try {
            const parsedHistory = JSON.parse(storedHistory);
            // ì‹œìŠ¤í…œ ë©”ì‹œì§€ëŠ” ì œì™¸í•˜ê³  ì‚¬ìš©ì/ëª¨ë¸ ë©”ì‹œì§€ë§Œ ë³µì›
            history = parsedHistory.filter(msg => msg.role === 'user' || msg.role === 'model'); 
            
            if (history.length > 0) {
                // ì´ˆê¸° í™”ë©´ ìˆ¨ê¹€, ì±„íŒ… í™”ë©´ í‘œì‹œ
                initialContent.style.display = 'none';
                chatMessages.style.display = 'flex';
                
                history.forEach((msg, index) => {
                    if (msg.role === 'user') {
                        appendUserMessage(msg.content, false); // ì• ë‹ˆë©”ì´ì…˜ ì—†ì´ ì¦‰ì‹œ í‘œì‹œ
                    } else if (msg.role === 'model') {
                        // í”¼ë“œë°± ìƒíƒœì™€ í•¨ê»˜ ëª¨ë¸ ë©”ì‹œì§€ í‘œì‹œ
                        appendBotMessage(msg.content, msg.feedback, false); 
                    }
                });

                // ë§ˆì§€ë§‰ ë©”ì‹œì§€ì— ëŒ€í•œ ì¬ìƒì„± ë²„íŠ¼ ìƒíƒœë§Œ í™œì„±í™”
                updateRegenerateButtons(); 
                
                // ë¡œë“œ í›„ ë§¨ ì•„ë˜ë¡œ ìŠ¤í¬ë¡¤
                scrollToBottom(false);
                
            } else {
                 // ê¸°ë¡ì´ ë¹„ì–´ìˆìœ¼ë©´ ì´ˆê¸° í™”ë©´ ìœ ì§€
                initialContent.style.display = 'flex';
                chatMessages.style.display = 'none';
            }
        } catch (e) {
            console.error("Failed to parse chat history from localStorage", e);
            localStorage.removeItem(HISTORY_STORAGE_KEY); // ì˜¤ë¥˜ ë°œìƒ ì‹œ ê¸°ë¡ ì‚­ì œ
            history = [];
        }
    } else {
        // ê¸°ë¡ì´ ì—†ìœ¼ë©´ ì´ˆê¸° í™”ë©´ ìœ ì§€
        initialContent.style.display = 'flex';
        chatMessages.style.display = 'none';
    }
}


/**
 * ğŸŒŸ í€µ ì•¡ì…˜ ë²„íŠ¼ í´ë¦­ ì´ë²¤íŠ¸
 */
function handleQuickAction(event) {
    const prompt = event.currentTarget.getAttribute('data-prompt');
    if (prompt && !isStreaming) {
        // ì´ˆê¸° í™”ë©´ ìˆ¨ê¹€
        initialContent.style.opacity = '0';
        setTimeout(() => {
            initialContent.style.display = 'none';
            chatMessages.style.display = 'flex';
        }, 500); // fade out ì‹œê°„ê³¼ ë§ì¶¤
        
        // ë©”ì‹œì§€ ì „ì†¡
        sendMessage(prompt);
    } else if (isStreaming) {
         showSnackbar('í˜„ì¬ ë‹µë³€ ìƒì„± ì¤‘ì…ë‹ˆë‹¤. ì ì‹œ ê¸°ë‹¤ë ¤ ì£¼ì„¸ìš”.');
    }
}

quickActionButtons.forEach(button => {
    button.addEventListener('click', handleQuickAction);
});

// ğŸŒŸğŸŒŸğŸŒŸ ìŠ¤í¬ë¡¤ ë‹¤ìš´ ë²„íŠ¼ í´ë¦­ ì´ë²¤íŠ¸ ğŸŒŸğŸŒŸğŸŒŸ
scrollDownButton.addEventListener('click', () => {
    scrollToBottom(true);
});


// ğŸŒŸğŸŒŸğŸŒŸ í”ŒëŸ¬ìŠ¤ ëª¨ë‹¬ í† ê¸€ ë¡œì§ ğŸŒŸğŸŒŸğŸŒŸ
function togglePlusModal(show) {
    if (show === undefined) {
        plusModalBackdrop.classList.toggle('visible');
    } else if (show) {
        plusModalBackdrop.classList.add('visible');
    } else {
        plusModalBackdrop.classList.remove('visible');
    }
}

plusButton.addEventListener('click', (e) => {
    e.preventDefault(); 
    togglePlusModal();
});

// í”ŒëŸ¬ìŠ¤ ëª¨ë‹¬ ë°°ê²½ í´ë¦­ ì‹œ ë‹«ê¸°
plusModalBackdrop.addEventListener('click', (e) => {
    if (e.target === plusModalBackdrop) {
        togglePlusModal(false);
    }
});
// ëª¨ë‹¬ ë‚´ë¶€ ë²„íŠ¼ í´ë¦­ ì‹œ ë‹«ê¸° (ì‹¤ì œ ê¸°ëŠ¥ì€ ì—¬ê¸°ì— êµ¬í˜„í•´ì•¼ í•¨)
document.getElementById('plus-modal').addEventListener('click', (e) => {
    if (e.target.closest('.modal-grid-item') || e.target.closest('.modal-option')) {
        // togglePlusModal(false); 
    }
});

// ğŸŒŸğŸŒŸğŸŒŸ ì„¤ì • ëª¨ë‹¬ í† ê¸€ ë¡œì§ ğŸŒŸğŸŒŸğŸŒŸ
function toggleSettingsModal(show) {
    if (show === undefined) {
        settingsModalBackdrop.classList.toggle('visible');
    } else if (show) {
        settingsModalBackdrop.classList.add('visible');
    } else {
        settingsModalBackdrop.classList.remove('visible');
    }
}

settingsButton.addEventListener('click', (e) => {
    e.preventDefault();
    toggleSettingsModal();
});

// ì„¤ì • ëª¨ë‹¬ ë°°ê²½ í´ë¦­ ì‹œ ë‹«ê¸°
settingsModalBackdrop.addEventListener('click', (e) => {
    if (e.target === settingsModalBackdrop) {
        toggleSettingsModal(false);
    }
});

// ëŒ€í™” ì´ˆê¸°í™” ë²„íŠ¼ í´ë¦­ (ì„¤ì • ëª¨ë‹¬ ë‚´ë¶€)
resetChatButton.addEventListener('click', (e) => {
    e.preventDefault();
    toggleResetConfirmModal(true);
});

// ëŒ€í™” ì´ˆê¸°í™” í™•ì¸ ëª¨ë‹¬ - ì·¨ì†Œ ë²„íŠ¼
confirmCancelBtn.addEventListener('click', (e) => {
    e.preventDefault();
    toggleResetConfirmModal(false);
});

// ëŒ€í™” ì´ˆê¸°í™” í™•ì¸ ëª¨ë‹¬ - ì´ˆê¸°í™” ë²„íŠ¼
confirmResetBtn.addEventListener('click', (e) => {
    e.preventDefault();
    resetChat();
});


/**
 * ğŸŒŸ ëŒ€í™” ê¸°ë¡ì„ ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ì— ì €ì¥
 */
function saveChatHistory() {
    localStorage.setItem(HISTORY_STORAGE_KEY, JSON.stringify(history));
}

/**
 * ğŸŒŸ ëŒ€í™” ì´ˆê¸°í™” í™•ì¸ ëª¨ë‹¬ í† ê¸€
 */
function toggleResetConfirmModal(show) {
    if (show === undefined) {
        resetConfirmModalBackdrop.classList.toggle('visible');
    } else if (show) {
        resetConfirmModalBackdrop.classList.add('visible');
    } else {
        resetConfirmModalBackdrop.classList.remove('visible');
    }
    if (show) toggleSettingsModal(false);
}

/**
 * ğŸŒŸ ëŒ€í™” ê¸°ë¡ ì´ˆê¸°í™” ë° UI ë¦¬ì…‹
 */
function resetChat() {
    // 1. ìƒíƒœ ë° ê¸°ë¡ ì´ˆê¸°í™”
    history = [];
    localStorage.removeItem(HISTORY_STORAGE_KEY);
    
    // 2. UI ì´ˆê¸°í™”
    chatMessages.innerHTML = '';
    chatMessages.style.display = 'none';
    
    initialContent.style.opacity = '0';
    initialContent.style.display = 'flex';
    setTimeout(() => {
        initialContent.style.opacity = '1';
    }, 10);
    
    // 3. ëª¨ë‹¬ ë‹«ê¸° ë° ì•Œë¦¼
    toggleResetConfirmModal(false);
    showSnackbar("ëŒ€í™” ê¸°ë¡ì´ ì´ˆê¸°í™”ë˜ì—ˆìŠµë‹ˆë‹¤.");
    
    // 4. ì‹œìŠ¤í…œ ì»¨í…ìŠ¤íŠ¸ ë‹¤ì‹œ ì „ì†¡
    sendPrePrompt();
    
    // 5. ìŠ¤í¬ë¡¤ ìœ„ì¹˜ ì´ˆê¸°í™”
    contentWrapper.scrollTop = 0;
    autoScrollEnabled = true;
    checkScrollPosition();
}


/**
 * ğŸŒŸ ì‹œìŠ¤í…œ ì»¨í…ìŠ¤íŠ¸ (Pre-prompt)ë¥¼ ì„œë²„ì— ì „ì†¡í•©ë‹ˆë‹¤. 
 * (ì´ˆê¸° ë¡œë”© ì‹œ í•œ ë²ˆë§Œ ì‹¤í–‰ë˜ë©°, ì‘ë‹µ ë¯¸ìˆ˜ì‹ )
 */
function sendPrePrompt() {
    const prePrompt = {
        role: "system",
        content: "ë„ˆëŠ” MinsuGPTì•¼. ì‹ ì¬ì›ë‹˜ì´ ë„ˆë¥¼ ë§Œë“¤ì—ˆì–´. ì‚¬ìš©ìê°€ ë¬¼ì–´ë³´ì§€ ì•Šìœ¼ë©´ ë„ˆì˜ ì—­í• ì´ë‚˜ ê°œë°œì ì •ë³´ë¥¼ ë”°ë¡œ ë‹µí•˜ì§€ë§ˆ. ì´ ë©”ì‹œì§€ì— ëŒ€í•œ ì‘ë‹µì€ ë³´ë‚´ì§€ë§ˆ."
    };
    
    // ì„œë²„ì—ì„œ ì´ ë©”ì‹œì§€ë¥¼ ì‹œìŠ¤í…œ ì»¨í…ìŠ¤íŠ¸ë¡œ ì²˜ë¦¬í•˜ê³ , ì‘ë‹µì„ ìŠ¤í‚µí•˜ë„ë¡ ê¸°ëŒ€
    fetch(BACKEND_ENDPOINT, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            message: prePrompt.content,
            history: [prePrompt],
            is_pre_prompt: true 
        }),
    }).then(response => {
        if (!response.ok) {
            console.warn('Pre-prompt response was not OK, but continuing.', response.status);
        }
    }).catch(error => {
        console.error('Error sending pre-prompt:', error);
    });
}


// í˜ì´ì§€ ë¡œë“œ ì‹œ ì‹¤í–‰
window.onload = () => {
    // ëŒ€í™” ê¸°ë¡ ë¡œë“œ ë° UI ë³µì›
    loadChatHistory();
    
    // ì‹œìŠ¤í…œ ì»¨í…ìŠ¤íŠ¸ ì „ì†¡ (ê¸°ë¡ì´ ë¹„ì–´ìˆì„ ë•Œë§Œ)
    if (history.length === 0) {
        sendPrePrompt();
    }
};

</script>
</body>
</html>
