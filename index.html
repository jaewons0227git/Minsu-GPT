<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>MinsuGPT</title> 
  
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Elms+Sans:ital,wght@0,100..900;1,100..900;0,100..900;1,100..900&display=swap" rel="stylesheet">
  <style>
    :root{
      --bg: #ffffff;
      --accent:#111827; /* ê²€ì€ìƒ‰ ê³„ì—´ */
      --send-button-disabled: #9ca3af;
      --send-button-enabled: #111827; 
      --composer-padding: 6px 12px;
      --composer-padding-v: 12px; 
      --input-container-padding-v: 8px; 
      --font-size: 16px;
      --line-height: 1.4;
      
      --line-height-px: 22.4; 
      --min-textarea-height: 22.4px; 
      
      --min-input-container-height: 48px; 
      
      --sidebar-width: 300px; /* ì‚¬ì´ë“œë°” ë„ˆë¹„ */
      
      font-family: 'Elms Sans', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Noto Sans KR', 'Helvetica Neue', Arial, sans-serif;
    }
    *{
        box-sizing:border-box;
        -webkit-tap-highlight-color: transparent; 
    }
    body{
      margin:0;
      background:var(--bg);
      color:var(--accent);
      min-height:100vh;
      display:flex;
      justify-content:center;
      padding:0;
    }
    .phone{
      width:100%;
      background:var(--bg);
      border-radius:0;
      overflow:hidden;
      border:none;
      display:flex;
      flex-direction:column;
      min-height:100vh;
      position:relative; 
      margin: 0;
    }
    
    /* ğŸŒŸğŸŒŸğŸŒŸ ì‚¬ì´ë“œë°” CSS ğŸŒŸğŸŒŸğŸŒŸ */
    #sidebar {
        position: fixed;
        top: 0;
        left: 0;
        width: var(--sidebar-width);
        height: 100vh;
        background-color: var(--bg);
        z-index: 200; 
        box-shadow: 2px 0 5px rgba(0,0,0,0.1);
        transform: translateX(-100%);
        transition: transform 0.3s ease;
        padding: 16px 0;
        display: flex;
        flex-direction: column;
        overflow-y: auto;
    }
    #sidebar.open {
        transform: translateX(0);
    }
    #menu-backdrop {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.5);
        opacity: 0;
        visibility: hidden;
        transition: opacity 0.3s ease, visibility 0.3s ease;
        z-index: 150;
    }
    #menu-backdrop.visible {
        opacity: 1;
        visibility: visible;
    }
    
    .sidebar-menu-item {
        display: flex;
        align-items: center;
        padding: 10px 16px;
        cursor: pointer;
        font-size: 16px;
        font-weight: 500;
        transition: background-color 0.1s;
    }
    .sidebar-menu-item:hover {
        background-color: #f1f4f9;
    }
    .sidebar-menu-item svg {
        width: 20px;
        height: 20px;
        margin-right: 12px;
        stroke: var(--accent);
        fill: none;
        stroke-width: 2;
        transition: transform 0.1s;
    }
    
    .chat-list-container {
        padding: 16px 16px 10px 16px;
        border-top: 1px solid #e5e8eb;
        margin-top: 10px;
        flex-grow: 1;
        overflow-y: auto;
    }
    .chat-search input {
        width: 100%;
        padding: 8px 12px;
        border: 1px solid #d1d5db;
        border-radius: 20px;
        font-size: 15px;
        margin-bottom: 15px;
        outline: none;
        box-sizing: border-box;
    }
    .chat-list-title {
        font-weight: 600;
        margin-bottom: 10px;
        font-size: 14px;
        color: #6b7280;
    }
    .chat-list-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 8px 10px;
        border-radius: 8px;
        cursor: pointer;
        font-size: 15px;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        transition: background-color 0.1s;
    }
    .chat-list-item:hover {
        background-color: #f1f4f9;
    }
    .chat-list-item .chat-title {
        flex-grow: 1;
        overflow: hidden;
        text-overflow: ellipsis;
        margin-right: 10px;
    }
    .delete-chat-btn {
        flex-shrink: 0;
        width: 20px;
        height: 20px;
        opacity: 0.5;
        transition: opacity 0.1s;
    }
    .delete-chat-btn:hover {
        opacity: 1;
        color: #ef4444;
    }
    
    /* PC ë²„ì „: ì‚¬ì´ë“œë°”ê°€ ì±„íŒ…ì°½ì„ ë°€ê³  ë“¤ì–´ì˜´ */
    @media (min-width: 900px) {
        #sidebar {
            position: sticky;
            top: 0;
            z-index: 100;
            transform: translateX(0); /* í•­ìƒ ì—´ë ¤ìˆìŒ */
            box-shadow: none;
            border-right: 1px solid #e5e8eb;
        }
        #menu-backdrop {
            display: none;
        }
        .phone {
            flex-direction: row; /* ê°€ë¡œ ë°°ì—´ */
            overflow: visible;
        }
        .content-wrapper {
            transition: margin-left 0.3s ease;
            width: 100%; /* ë‚¨ì€ ê³µê°„ ì°¨ì§€ */
            overflow-y: auto;
            max-width: calc(100% - var(--sidebar-width)); 
        }
        .header {
            margin-left: 0;
            width: 100%; /* content-wrapper ë„ˆë¹„ì— ë§ì¶¤ */
        }
        /* ë©”ë‰´ ë²„íŠ¼ì€ ìˆ¨ê¹€ */
        .header .menu-icon {
            display: none; 
        }
    }
    

    /* ==================================== */
    .header{
      display:flex;
      justify-content:space-between;
      align-items:center;
      padding:10px 16px;
      height:56px;
      border-bottom:none;
      
      position: sticky;
      top: 0;
      z-index: 100; 
      background: var(--bg); 
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05); 
    }
    .header-icon{
      width:32px;
      height:32px;
      display:flex;
      align-items:center;
      justify-content:center;
      color:#111827;
      cursor: pointer;
    }
    .plus-btn{
      background-color:#f1f4ff;
      color:#1d6fef;
      font-weight:600;
      padding:6px 14px;
      border-radius:20px;
      display:flex;
      align-items:center;
      gap:4px;
      font-size:14px;
      cursor: pointer;
    }
    .plus-btn svg{
      width:16px;
      height:16px;
      fill:currentColor;
      transform:translateY(1px);
    }
    .profile-btn{
      width:32px;
      height:32px;
      border-radius:50%;
      background-color:#e5e8eb;
      display:flex;
      align-items:center;
      justify-content:center;
      color:#111827;
      cursor: pointer;
    }

    .content-wrapper{
        flex-grow:1;
        display:flex;
        flex-direction:column;
        overflow-y: auto;
        padding-bottom: 0; 
        position: relative;
    }
    
    #initial-content{
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      width: 100%;
      max-width: 400px;
      display:flex;
      flex-direction:column;
      align-items:center;
      text-align:center;
      padding: 0 16px;
      transition: opacity 0.5s ease-in-out, visibility 0.5s ease-in-out;
    }
    .main-question{
      font-size:22px;
      font-weight:600;
      margin-bottom:40px;
      color:#111827;
    }
    .quick-actions{
      display:flex;
      flex-wrap:wrap;
      justify-content:center;
      gap:8px;
      max-width:400px; 
    }
    .action-btn{
      display:flex;
      align-items:center;
      justify-content:center;
      padding:10px 16px;
      border:1px solid #e5e8eb;
      border-radius:30px;
      font-size:15px;
      font-weight:500;
      color:#111827;
      min-height:48px;
      white-space:nowrap;
      cursor: pointer;
    }
    .action-btn svg, .action-btn .icon-light{
      margin-right:6px;
      width:20px;
      height:20px;
    }
    .action-btn.new-green svg{ stroke:#28a745; }
    .action-btn.new-blue svg{ stroke:#007bff; }
    .action-btn.orange svg{ stroke:#fd7e14; } 

    .chat-messages{
      width: 100%;
      padding: 10px 16px;
      display: none;
      flex-direction: column;
      justify-content: flex-start; 
      gap: 10px;
      margin: 0 auto; 
    }
    @media (min-width: 600px) {
        .chat-messages {
            max-width: 768px; 
            padding-left: 0;
            padding-right: 0;
        }
    }

    .message-container {
        display: flex;
        flex-direction: column;
        gap: 4px;
    }
    .message-bubble{
      display: flex;
      max-width: 80%;
    }
    .message-text{
      padding: 10px 14px;
      border-radius: 20px;
      line-height: 1.4;
      font-size: 15px;
      white-space: pre-wrap;
    }
    .user-message{
      justify-content: flex-end;
      align-self: flex-end;
    }
    .user-message .message-text{
      background-color: #f1f4f9; 
      color: var(--accent); 
      border-bottom-right-radius: 4px;
    }
    
    .bot-message-wrapper {
        align-self: flex-start;
        margin-top: 10px;
        padding: 0; 
        color: var(--accent);
        line-height: 1.4;
        font-size: 15px;
        width: 100%; 
        box-sizing: border-box;
    }
    
    .bot-message .streaming-block {
        display: block;
        padding: 0; 
        border-radius: 0; 
        background-color: transparent; 
        max-width: 100%;
        box-sizing: border-box;
        white-space: normal;
        color: var(--accent); 
        opacity: 1 !important; 
        transform: translateY(0) !important;
        transition: none !important; 
    }

    .bot-message h1, .bot-message h2, .bot-message h3 {
        font-weight: 700;
        margin: 1.5em 0 0.8em 0; 
        line-height: 1.3;
        clear: both;
    }
    .bot-message h1 { font-size: 1.8em; } 
    .bot-message h2 { font-size: 1.5em; } 
    .bot-message h3 { font-size: 1.25em; } 

    .bot-message strong, .bot-message b {
        font-weight: 700; 
    }

    .bot-message pre {
        background-color: #f3f4f6; 
        padding: 10px;
        border-radius: 6px;
        overflow-x: auto;
        font-size: 0.9em;
        margin: 8px 0;
        white-space: pre-wrap;
    }
    .bot-message code {
        font-family: monospace;
    }
    .bot-message .streaming-block code {
        background-color: #e5e7eb;
        padding: 2px 4px;
        border-radius: 3px;
        font-weight: normal;
    }
    
    .bot-message p {
        margin: 0.5em 0; 
    }
    /* --------------------------------- */

    .thinking-indicator-text {
        font-weight: 500;
        padding: 10px 0; 
        background-color: var(--accent); 
        background-image: linear-gradient(
            90deg,
            #111827 0%,
            #ffffff 20%, 
            #111827 40%
        );
        background-size: 200% 100%; 
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        animation: shimmer 1.5s infinite linear;
    }

    @keyframes shimmer {
        0% {
            background-position: 100% 0; 
        }
        100% {
            background-position: -100% 0; 
        }
    }

    /* ğŸŒŸğŸŒŸğŸŒŸ ë©”ì‹œì§€ ì•¡ì…˜ ë²„íŠ¼ ìŠ¤íƒ€ì¼ ğŸŒŸğŸŒŸğŸŒŸ */
    .message-actions {
        display: flex;
        gap: 8px;
        margin-top: 8px;
        padding-left: 2px;
        align-items: center;
        visibility: hidden; /* ê¸°ë³¸ ìˆ¨ê¹€ */
        opacity: 0;
        transition: opacity 0.2s;
    }
    .bot-message-wrapper:hover .message-actions {
        visibility: visible;
        opacity: 1;
    }
    .action-icon-btn {
        width: 20px;
        height: 20px;
        cursor: pointer;
        opacity: 0.5;
        transition: opacity 0.1s;
    }
    .action-icon-btn:hover {
        opacity: 1;
        color: var(--accent);
    }
    .action-icon-btn svg {
        width: 100%;
        height: 100%;
        stroke: #6b7280;
        stroke-width: 2;
        fill: none;
        transition: stroke 0.1s, fill 0.1s;
    }
    .action-icon-btn.liked svg {
        fill: #3b82f6; 
        stroke: #3b82f6; 
    }
    .action-icon-btn.disliked svg {
        fill: #ef4444; 
        stroke: #ef4444; 
    }
    .action-icon-btn .fill-icon {
        fill: #6b7280;
    }
    
    .composer{
      position:fixed;
      bottom:0;
      left:0;
      right:0;
      width:100%;
      display:flex;
      justify-content:center;
      padding:var(--composer-padding);
      background:var(--bg);
      box-shadow:none; 
      height: auto;
      min-height: calc(var(--min-input-container-height) + var(--composer-padding-v)); 
      z-index: 10; 
    }
    /* PC ë²„ì „: composer ìœ„ì¹˜ ì¡°ì • */
    @media (min-width: 900px) {
        .composer {
            left: var(--sidebar-width);
            width: calc(100% - var(--sidebar-width));
        }
    }
    
    .composer-inner{
      display:flex;
      align-items:center; 
      gap:8px;
      width:100%;
    }
    @media (min-width: 600px) {
        .composer-inner {
            max-width: 768px; 
        }
    }

    .input-container{
      flex:1;
      display:flex;
      align-items: center; 
      gap:8px;
      border-radius:24px;
      border:1px solid #d1d5db;
      padding:4px 4px 4px 16px;
      box-sizing:border-box;
      background:#ffffff;
      max-height: 150px; 
      overflow: hidden; 
      min-height: var(--min-input-container-height); 
    }
    .input-container textarea{
      flex:1;
      border:0;
      outline:0;
      background:transparent;
      color:var(--accent);
      font-size:var(--font-size);
      min-width:0;
      resize: none; 
      min-height: var(--min-textarea-height); 
      overflow-y: hidden; 
      padding: 0; 
      line-height: var(--line-height);
      vertical-align: middle; 
      align-self: center; 
      font-family: inherit; 
    }
    .input-container textarea::placeholder{
        color:#9ca3af;
        font-family: inherit;
    }

    .plus{
      width: var(--min-input-container-height); 
      height: var(--min-input-container-height); 
      border-radius:50%;
      background:#ffffff;
      border:1px solid #d1d5db;
      display:flex;
      align-items:center;
      justify-content:center;
      flex-shrink:0;
      align-self: center; 
      cursor: pointer;
    }
    .plus svg {
      width: 20px; 
      height: 20px;
      fill: #111827;
    }

    .mic-voice-container{
        display:flex;
        gap:8px;
        flex-shrink:0;
        margin-bottom: 0;
    }
    .mic-icon{
        width:38px;
        height:38px;
        display:flex;
        align-items:center;
        justify-content:center;
        flex-shrink:0;
        color:#9ca3af;
    }
    .send-btn, .stop-btn{
      width:38px;
      height:38px;
      border-radius:50%;
      display:flex;
      align-items:center;
      justify-content:center;
      flex-shrink:0;
      margin-left:0;
      margin-right:4px;
      transition: background-color 0.2s ease;
      cursor: pointer;
    }
    .send-btn:not(.active) {
        background-color: var(--send-button-disabled);
        pointer-events: none;
    }
    .send-btn.active {
        background-color: var(--send-button-enabled); 
        pointer-events: auto;
    }
    .send-btn svg path {
        stroke-width: 2.5;
    }
    .stop-btn {
        background-color: #ef4444; 
    }

    /* ëª¨ë‹¬ ìŠ¤íƒ€ì¼ (ì´ì „ê³¼ ë™ì¼) */
    #modal-backdrop {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.5);
        opacity: 0;
        visibility: hidden;
        transition: opacity 0.3s ease, visibility 0.3s ease;
        z-index: 1000;
        display: flex;
        justify-content: center;
        align-items: flex-end;
    }
    #modal-backdrop.visible {
        opacity: 1;
        visibility: visible;
    }
    #plus-modal {
        width: 100%;
        max-width: 768px; 
        background-color: var(--bg);
        border-top-left-radius: 20px;
        border-top-right-radius: 20px;
        padding: 24px 16px 40px 16px; 
        transform: translateY(100%);
        transition: transform 0.3s ease-out;
    }
    #modal-backdrop.visible #plus-modal {
        transform: translateY(0);
    }
    .modal-handle {
        width: 40px;
        height: 5px;
        background-color: #e5e8eb;
        border-radius: 5px;
        margin: 0 auto 20px auto;
    }
    .modal-grid {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 8px;
        margin-bottom: 24px;
    }
    .modal-grid-item {
        display: flex;
        flex-direction: column;
        align-items: center;
        text-align: center;
        padding: 12px 0;
        background-color: #f1f4f9; 
        border-radius: 12px;
        font-size: 14px;
        font-weight: 500;
        cursor: pointer;
    }
    .modal-grid-icon {
        width: 48px;
        height: 48px;
        background-color: #e5e8eb; 
        border-radius: 12px;
        margin-bottom: 8px;
        display: flex;
        align-items: center;
        justify-content: center;
    }
    .modal-grid-icon svg {
        width: 24px;
        height: 24px;
        stroke: #111827;
        fill: none;
        stroke-width: 2;
    }
    .modal-option {
        display: flex;
        align-items: center;
        padding: 12px 10px;
        font-size: 16px;
        font-weight: 500;
        cursor: pointer;
        border-radius: 8px;
        transition: background-color 0.1s ease;
    }
    .modal-option:hover {
        background-color: #f1f4f9;
    }
    .modal-option-icon {
        margin-right: 12px;
        width: 28px;
        height: 28px;
        display: flex;
        align-items: center;
        justify-content: center;
    }
    .modal-option-icon svg {
        width: 20px;
        height: 20px;
    }
  </style>
</head>
<body>
  
  <aside id="sidebar">
      <div class="sidebar-menu-item" id="new-chat-btn">
          <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
              <path d="M12 20h9M16.5 3.5a2.121 2.121 0 0 1 3 3L7 19l-4 1 1-4L16.5 3.5z" stroke-linecap="round" stroke-linejoin="round"/>
          </svg>
          ìƒˆ ì±„íŒ…
      </div>
      
      <div class="chat-list-container">
          <div class="chat-search">
              <input type="text" id="chat-search-input" placeholder="ì±„íŒ… ê²€ìƒ‰"/>
          </div>
          <div class="chat-list-title">ìµœê·¼ ëŒ€í™”</div>
          <div id="chat-list">
              </div>
      </div>
  </aside>
  
  <div id="menu-backdrop"></div>


  <div class="phone" role="application" aria-label="ì±„íŒ… UI">
    <header class="header">
        <div class="header-icon menu-icon" id="menu-button">
            <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" width="24" height="24">
                <path d="M4 6h16M4 12h16M4 18h16" stroke="#111827" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>
        </div>
        
        <div class="plus-btn">
            <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" width="16" height="16">
                <path d="M12 2C6.477 2 2 6.477 2 12s4.477 10 10 10 10-4.477 10-10S17.523 2 12 2zm-1 14h2v-4h4V10h-4V6h-2v4H7v2h4v4z" fill="currentColor" />
            </svg>
            Ultra ì´ìš©í•˜ê¸°
        </div>
        <div class="header-icon profile-btn">
            <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" width="24" height="24">
                <path d="M12 2a5 5 0 0 0-5 5v1a3 3 0 0 0-3 3v4a3 3 0 0 0 3 3h10a3 3 0 0 0 3-3v-4a3 3 0 0 0-3-3V7a5 5 0 0 0-5-5zM9 7a3 3 0 0 1 6 0v1H9V7z" stroke="#111827" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                <circle cx="12" cy="17" r="2" fill="#111827"/>
            </svg>
        </div>
    </header>

    <main class="content-wrapper" id="content-wrapper">
        <div id="initial-content">
            <div class="main-question">ì•ˆë…•í•˜ì„¸ìš”! ë°˜ê°€ì›Œìš”</div>
            <div class="quick-actions">
                <div class="action-btn new-green">
                    <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" width="20" height="20">
                        <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2v10z" stroke="#28a745" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                    </svg>
                    í…ìŠ¤íŠ¸ì™€ í•¨ê»˜ ëŒ€í™”í•˜ê¸°
                </div>
                <div class="action-btn">
                    <div class="icon-light">ğŸ’¡</div>
                    ë¸Œë ˆì¸ìŠ¤í† ë°
                </div>
                <div class="action-btn new-blue">
                    <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" width="20" height="20">
                        <path d="M12 20h9M16.5 3.5a2.121 2.121 0 0 1 3 3L7 19l-4 1 1-4L16.5 3.5z" stroke="#007bff" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                    </svg>
                    ê¸€ ì“°ê¸°
                </div>
                <div class="action-btn orange">
                    <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" width="20" height="20">
                        <path d="M4 19.5V21a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2v-1.5M4 4.5V3a2 2 0 0 1 2-2h12a2 2 0 0 1 2 2v1.5M6 10h12M6 14h8" stroke="#fd7e14" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                    </svg>
                    í…ìŠ¤íŠ¸ ìš”ì•½
                </div>
                <div class="action-btn">
                    <div style="font-size:18px;">...</div>
                    ë” ë³´ê¸°
                </div>
            </div>
        </div>

        <div id="chat-messages" class="chat-messages">
            </div>
    </main>

    <div id="composer" class="composer">
      <div class="composer-inner">
        <div class="plus" id="plus-button" aria-label="íŒŒì¼ ì²¨ë¶€">
            <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" width="20" height="20">
                <path d="M12 4V20M4 12H20" stroke="#111827" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>
        </div>

        <div id="input-container" class="input-container">
          <textarea id="message-input" placeholder="Minsu GPT" rows="1"></textarea>
          
          <div class="mic-voice-container">
            <div id="mic-icon" class="mic-icon">
                <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" width="22" height="22">
                    <path d="M12 14a3 3 0 0 0 3-3V7a3 3 0 0 0-6 0v4a3 3 0 0 0 3 3z" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"/>
                    <path d="M19 11v1a7 7 0 0 1-14 0v-1" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"/>
                </svg>
            </div>
            
            <div id="action-button-container">
                <div id="send-button" class="send-btn">
                  <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" width="18" height="18">
                    <path d="M5 12h14M13 6l6 6-6 6" stroke="#fff" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"/>
                  </svg>
                </div>
                <div id="stop-button" class="stop-btn" style="display:none;">
                    <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" width="18" height="18">
                        <rect x="6" y="6" width="12" height="12" rx="2" fill="white"/>
                        <rect x="6" y="6" width="12" height="12" rx="2" stroke="white" stroke-width="2"/>
                    </svg>
                </div>
            </div>
          </div>
        </div>
      </div>
    </div>
    
    <div id="modal-backdrop">
        <div id="plus-modal">
            <div class="modal-handle"></div>
            
            <div class="modal-grid">
                <div class="modal-grid-item" data-action="camera">
                    <div class="modal-grid-icon">
                        <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <path d="M2 8a2 2 0 0 1 2-2h2l1-3h6l1 3h2a2 2 0 0 1 2 2v8a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V8z"/>
                            <circle cx="12" cy="13" r="3"/>
                        </svg>
                    </div>
                    ì¹´ë©”ë¼
                </div>
                <div class="modal-grid-item" data-action="album">
                    <div class="modal-grid-icon">
                        <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <rect x="3" y="3" width="18" height="18" rx="2"/>
                            <circle cx="8.5" cy="8.5" r="1.5"/>
                            <path d="M21 15l-4-4L6 21"/>
                        </svg>
                    </div>
                    ì•¨ë²”
                </div>
                <div class="modal-grid-item" data-action="file">
                    <div class="modal-grid-icon">
                        <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <path d="M15 7l4 4V19a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h8l4 4z"/>
                            <path d="M10 10v4M12 12h-4"/>
                        </svg>
                    </div>
                    íŒŒì¼
                </div>
            </div>
            
            <div class="modal-option" data-action="create-image">
                <div class="modal-option-icon">
                    <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <path d="M12 20h9M16.5 3.5a2.121 2.121 0 0 1 3 3L7 19l-4 1 1-4L16.5 3.5z" stroke="#111827" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                    </svg>
                </div>
                ì´ë¯¸ì§€ ë§Œë“¤ê¸°
            </div>
            
            <div class="modal-option" data-action="set-reminder">
                <div class="modal-option-icon">
                    <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <path d="M9 12l2 2 4-4m7 4a9 9 0 1 1-18 0 9 9 0 0 1 18 0z" stroke="#111827" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                    </svg>
                </div>
                ë¦¬ë§ˆì¸ë” ë“±ë¡í•˜ê¸°
            </div>
            
        </div>
    </div>
    
  </div>

  <script>
    // ----------------------------------------------
    // |         ì›¹í˜ì´ì§€ ë³µì œ ë°©ì§€ ê¸°ëŠ¥ ì‹œì‘         |
    // ----------------------------------------------
    document.addEventListener('contextmenu', function(e) {
      e.preventDefault(); 
    });

    document.onkeydown = function(e) {
      if (e.keyCode == 123) { e.preventDefault(); return false; } 
      if (e.ctrlKey && e.shiftKey && (e.keyCode == 'I'.charCodeAt(0) || e.keyCode == 'J'.charCodeAt(0) || e.keyCode == 'C'.charCodeAt(0))) { e.preventDefault(); return false; } 
      if (e.ctrlKey && e.keyCode == 'U'.charCodeAt(0)) { e.preventDefault(); return false; } 
    };
    // ----------------------------------------------
    // |         ì›¹í˜ì´ì§€ ë³µì œ ë°©ì§€ ê¸°ëŠ¥ ë           |
    // ----------------------------------------------

    const inputField = document.getElementById('message-input');
    const sendButton = document.getElementById('send-button');
    const stopButton = document.getElementById('stop-button');
    const initialContent = document.getElementById('initial-content');
    const chatMessages = document.getElementById('chat-messages');
    const composer = document.getElementById('composer');
    const inputContainer = document.getElementById('input-container');
    const plusButton = document.getElementById('plus-button');
    const modalBackdrop = document.getElementById('modal-backdrop');
    const sidebar = document.getElementById('sidebar'); // ğŸŒŸ ì¶”ê°€
    const menuButton = document.getElementById('menu-button'); // ğŸŒŸ ì¶”ê°€
    const menuBackdrop = document.getElementById('menu-backdrop'); // ğŸŒŸ ì¶”ê°€
    const contentWrapper = document.getElementById('content-wrapper'); // ğŸŒŸ ì¶”ê°€
    const chatListContainer = document.getElementById('chat-list'); // ğŸŒŸ ì¶”ê°€
    const chatSearchInput = document.getElementById('chat-search-input'); // ğŸŒŸ ì¶”ê°€


    const BACKEND_ENDPOINT = "https://jaewondev.pythonanywhere.com/ask"; 

    // ğŸŒŸğŸŒŸğŸŒŸ ëŒ€í™” ê¸°ë¡ ë° ì±„íŒ… ëª©ë¡ ğŸŒŸğŸŒŸğŸŒŸ
    let history = []; 
    const HISTORY_KEY = 'minsuGPT_history'; // ëŒ€í™” ê¸°ë¡ ì €ì¥ í‚¤
    const CHAT_LIST_KEY = 'minsuGPT_chatlist'; // ì±„íŒ… ëª©ë¡ ì €ì¥ í‚¤
    let currentChatId = 'default'; // í˜„ì¬ ì±„íŒ… ID
    let chatList = [];

    const MAX_ROWS = 6;
    const MIN_ROWS = 1;
    // PC ë„ˆë¹„ ê¸°ì¤€ (ì‚¬ì´ë“œë°”ê°€ ë°€ê³  ë“¤ì–´ì˜¤ëŠ” ë„ˆë¹„)
    const PC_WIDTH_BREAKPOINT = 900; 
    const isMobile = () => window.innerWidth < PC_WIDTH_BREAKPOINT;
    
    let isStreaming = false; 
    let abortController = null; 

    // ===============================================
    // ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ ë° ì±„íŒ… ê´€ë¦¬ í•¨ìˆ˜
    // ===============================================

    function loadHistory() {
        const storedHistory = localStorage.getItem(`${HISTORY_KEY}_${currentChatId}`);
        if (storedHistory) {
            try {
                history = JSON.parse(storedHistory);
                renderHistory();
            } catch (e) {
                console.error("Failed to parse history from localStorage", e);
                history = [];
            }
        } else {
            history = [];
        }
        
        if (history.length > 0) {
            initialContent.style.display = 'none';
            chatMessages.style.display = 'flex';
        } else {
            initialContent.style.display = 'flex';
            chatMessages.style.display = 'none';
        }
    }

    function saveHistory() {
        localStorage.setItem(`${HISTORY_KEY}_${currentChatId}`, JSON.stringify(history));
    }
    
    function loadChatList() {
        const storedChatList = localStorage.getItem(CHAT_LIST_KEY);
        if (storedChatList) {
            try {
                chatList = JSON.parse(storedChatList);
            } catch (e) {
                console.error("Failed to parse chat list from localStorage", e);
                chatList = [];
            }
        }
        if (chatList.length === 0) {
            // ì´ˆê¸° ë”ë¯¸ ì±„íŒ… ìƒì„±
            chatList = [
                { id: 'default', title: 'ì•ˆë…•í•˜ì„¸ìš”! ë°˜ê°€ì›Œìš”' },
            ];
            saveChatList();
        }
    }
    
    function saveChatList() {
        localStorage.setItem(CHAT_LIST_KEY, JSON.stringify(chatList));
        renderChatList();
    }
    
    function createNewChat() {
        if (history.length > 0 && history[0].content.length > 0) {
             // í˜„ì¬ ì±„íŒ…ì„ ëª©ë¡ì— ì¶”ê°€ (ì²« ë©”ì‹œì§€ë¥¼ ì œëª©ìœ¼ë¡œ)
             const existingChat = chatList.find(c => c.id === currentChatId);
             if (!existingChat) {
                chatList.push({ 
                    id: currentChatId, 
                    title: history[0].content.length > 30 ? history[0].content.substring(0, 30) + '...' : history[0].content 
                });
             }
        }
        
        const newId = Date.now().toString();
        currentChatId = newId;
        history = [];
        saveChatList(); 
        
        initialContent.style.display = 'flex';
        chatMessages.style.display = 'none';
        // PC ëª¨ë“œì—ì„œ ì‚¬ì´ë“œë°”ê°€ ì—´ë ¤ìˆìœ¼ë¯€ë¡œ, ì±„íŒ…ì°½ì„ ë¹„ì›Œì¤Œ
        chatMessages.innerHTML = '';
        
        // ìƒˆë¡œìš´ ì±„íŒ… ëª©ë¡ ì¶”ê°€ (ì„ì‹œ ì œëª©)
        chatList.push({ id: newId, title: 'ìƒˆë¡œìš´ ì±„íŒ…' });
        saveChatList();
        closeSidebar();
        
        window.scrollTo(0, 0); // ìŠ¤í¬ë¡¤ ì´ˆê¸°í™”
    }

    function switchChat(chatId) {
        if (isStreaming) return;
        
        // ì´ì „ ì±„íŒ… ì €ì¥
        saveHistory(); 
        
        currentChatId = chatId;
        
        // ìƒˆ ì±„íŒ… ë¡œë“œ
        loadHistory();
        closeSidebar();
        
        // ì±„íŒ…ì°½ ë³´ì´ê¸°
        if (history.length > 0) {
            initialContent.style.display = 'none';
            chatMessages.style.display = 'flex';
        } else {
            initialContent.style.display = 'flex';
            chatMessages.style.display = 'none';
        }
        
        chatMessages.scrollTop = chatMessages.scrollHeight;
    }
    
    function deleteChat(chatId) {
        // ì±„íŒ… ëª©ë¡ì—ì„œ ì œê±°
        chatList = chatList.filter(c => c.id !== chatId);
        saveChatList();
        
        // ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ì—ì„œ ëŒ€í™” ê¸°ë¡ ì œê±°
        localStorage.removeItem(`${HISTORY_KEY}_${chatId}`);
        
        // í˜„ì¬ ì±„íŒ…ì„ ì‚­ì œí–ˆë‹¤ë©´, 'default' ì±„íŒ…ìœ¼ë¡œ ì „í™˜
        if (currentChatId === chatId) {
            currentChatId = 'default';
            loadHistory();
        }
    }
    
    function renderChatList(filterText = '') {
        const listElement = document.getElementById('chat-list');
        listElement.innerHTML = '';
        
        const filteredList = chatList.filter(chat => 
            chat.title.toLowerCase().includes(filterText.toLowerCase())
        );

        filteredList.forEach(chat => {
            const item = document.createElement('div');
            item.className = 'chat-list-item';
            item.setAttribute('data-id', chat.id);
            if (chat.id === currentChatId) {
                item.style.backgroundColor = '#e5e8eb'; // í˜„ì¬ ì„ íƒëœ ì±„íŒ… í•˜ì´ë¼ì´íŠ¸
            }
            
            const titleSpan = document.createElement('span');
            titleSpan.className = 'chat-title';
            titleSpan.textContent = chat.title;
            
            const deleteBtn = document.createElement('div');
            deleteBtn.className = 'delete-chat-btn';
            deleteBtn.innerHTML = `
                <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" stroke="currentColor">
                    <path d="M3 6h18M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6M8 6V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/>
                </svg>
            `;
            deleteBtn.addEventListener('click', (e) => {
                e.stopPropagation(); // ì±„íŒ… ì „í™˜ ë°©ì§€
                deleteChat(chat.id);
            });
            
            item.appendChild(titleSpan);
            item.appendChild(deleteBtn);
            
            item.addEventListener('click', () => switchChat(chat.id));
            listElement.appendChild(item);
        });
    }

    // ===============================================
    // UI ë¡œì§ í•¨ìˆ˜
    // ===============================================

    function toggleSendButton() {
        if (inputField.value.trim().length > 0 && !isStreaming) {
            sendButton.classList.add('active');
        } else {
            sendButton.classList.remove('active');
        }
    }
    inputField.addEventListener('input', toggleSendButton);

    function autoResizeTextarea() {
        const style = getComputedStyle(inputField);
        const line_height_px = parseFloat(style.getPropertyValue('--line-height-px')); 
        const composerPaddingV = 12; 
        const inputContainerPaddingV = 8; 
        const minInputContainerHeight = parseFloat(style.getPropertyValue('--min-input-container-height')); 

        inputField.rows = MIN_ROWS;
        inputField.style.height = 'auto'; 

        let scrollH = inputField.scrollHeight;
        let newRows = Math.round(scrollH / line_height_px);
        newRows = Math.max(MIN_ROWS, Math.min(MAX_ROWS, newRows));
        inputField.rows = newRows;
        inputField.style.height = 'auto';
        
        const finalTextareaHeight = inputField.offsetHeight; 
        const contentHeight = finalTextareaHeight + inputContainerPaddingV;
        const inputContainerHeight = Math.max(contentHeight, minInputContainerHeight);
        
        inputContainer.style.minHeight = `${inputContainerHeight}px`;

        const newComposerHeight = inputContainerHeight + composerPaddingV;
        composer.style.minHeight = `${newComposerHeight}px`;
        
        chatMessages.style.paddingBottom = `${newComposerHeight}px`;

        chatMessages.scrollTop = chatMessages.scrollHeight;
    }
    inputField.addEventListener('input', autoResizeTextarea);


    /**
     * history ë°°ì—´ì„ ê¸°ë°˜ìœ¼ë¡œ í™”ë©´ì— ëª¨ë“  ë©”ì‹œì§€ë¥¼ ë Œë”ë§
     */
    function renderHistory() {
        chatMessages.innerHTML = '';
        history.forEach((message, index) => {
            if (message.role === 'user') {
                appendUserMessage(message.content, false);
            } else if (message.role === 'model') {
                appendBotMessage(message.content, index, false);
            }
        });
        chatMessages.scrollTop = chatMessages.scrollHeight;
    }

    function appendUserMessage(message, isNew = true) {
        const userContainer = document.createElement('div');
        userContainer.className = 'message-container user-message-container';
        
        const userBubble = document.createElement('div');
        userBubble.className = 'message-bubble user-message';
        userBubble.innerHTML = `<div class="message-text">${message}</div>`;
        
        userContainer.appendChild(userBubble);
        chatMessages.appendChild(userContainer);
        
        if (isNew) {
            history.push({ role: 'user', content: message });
            saveHistory();
        }
        chatMessages.scrollTop = chatMessages.scrollHeight;
    }

    function appendBotMessage(message, index, isNew = true) {
        const botMessageWrapper = document.createElement('div');
        botMessageWrapper.className = 'bot-message-wrapper';
        botMessageWrapper.setAttribute('data-message-index', index);
        
        // ë´‡ ë©”ì‹œì§€ ë³¸ë¬¸
        const botMessageContainer = document.createElement('div');
        botMessageContainer.className = 'bot-message';
        botMessageContainer.innerHTML = renderMarkdown(message);
        
        // ğŸŒŸ ì•¡ì…˜ ë²„íŠ¼ ì»¨í…Œì´ë„ˆ
        const actions = createActionButtons(message, index); 
        
        botMessageWrapper.appendChild(botMessageContainer);
        botMessageWrapper.appendChild(actions);
        
        chatMessages.appendChild(botMessageWrapper);
        
        if (isNew) {
             // ìŠ¤íŠ¸ë¦¬ë° í›„ historyì— ì €ì¥í•˜ëŠ” ê³¼ì •ì€ sendMessage í•¨ìˆ˜ ë‚´ë¶€ì—ì„œ ì²˜ë¦¬
        }
        chatMessages.scrollTop = chatMessages.scrollHeight;
        
        return botMessageWrapper;
    }

    /**
     * ì‘ë‹µ ì•¡ì…˜ ë²„íŠ¼ (ë³µì‚¬, ì¢‹ì•„ìš”, ì‹«ì–´ìš”, ê³µìœ , ì¬ìƒì„±) ìƒì„±
     */
    function createActionButtons(messageContent, index) {
        const actionsDiv = document.createElement('div');
        actionsDiv.className = 'message-actions';
        actionsDiv.setAttribute('data-index', index);
        
        // 1. ë³µì‚¬ ë²„íŠ¼
        actionsDiv.innerHTML += `
            <div class="action-icon-btn copy-btn" title="ë³µì‚¬í•˜ê¸°" data-content="${encodeURIComponent(messageContent)}">
                <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                    <rect x="9" y="9" width="13" height="13" rx="2" ry="2" fill="none"/>
                    <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1" fill="none"/>
                </svg>
            </div>
            <div class="action-icon-btn like-btn" title="ì¢‹ì•„ìš”" data-index="${index}">
                <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                    <path d="M14 9V5a3 3 0 0 0-3-3l-4 9v11h11.28a2 2 0 0 0 2-1.7l1.38-9a2 2 0 0 0-2-2.3zM7 22H4a2 2 0 0 1-2-2v-7a2 2 0 0 1 2-2h3"/>
                </svg>
            </div>
            <div class="action-icon-btn dislike-btn" title="ì‹«ì–´ìš”" data-index="${index}">
                <path d="M10 15v4a3 3 0 0 0 3 3l4-9V2H5.72a2 2 0 0 0-2 1.7l-1.38 9a2 2 0 0 0 2 2.3zM17 2h3a2 2 0 0 1 2 2v7a2 2 0 0 1-2 2h-3"/>
                <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                    <path d="M10 15v4a3 3 0 0 0 3 3l4-9V2H5.72a2 2 0 0 0-2 1.7l-1.38 9a2 2 0 0 0 2 2.3zM17 2h3a2 2 0 0 1 2 2v7a2 2 0 0 1-2 2h-3"/>
                </svg>
            </div>
            <div class="action-icon-btn share-btn" title="ê³µìœ í•˜ê¸°">
                <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                    <path d="M4 12v8a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2v-8M16 6l-4-4-4 4M12 2v13"/>
                </svg>
            </div>
            <div class="action-icon-btn regenerate-btn" title="ë‹¤ì‹œ ë‹µë³€" data-index="${index}">
                <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                    <path d="M23 4v6h-6M1 20v-6h6M3.52 14A8.995 8.995 0 0 1 12 5a9 9 0 0 1 9 9 9 9 0 0 1-6.48 8.48"/>
                </svg>
            </div>
        `;
        
        // ğŸŒŸ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì—°ê²°
        actionsDiv.querySelectorAll('.action-icon-btn').forEach(btn => {
            btn.addEventListener('click', handleActionClick);
        });
        
        return actionsDiv;
    }

    /**
     * ì•¡ì…˜ ë²„íŠ¼ í´ë¦­ ì´ë²¤íŠ¸ ì²˜ë¦¬
     */
    function handleActionClick(e) {
        const btn = e.currentTarget;
        const className = btn.classList[1]; 
        const index = btn.getAttribute('data-index');
        const content = decodeURIComponent(btn.getAttribute('data-content') || '');
        
        switch (className) {
            case 'copy-btn':
                navigator.clipboard.writeText(content).then(() => {
                    alert('ë©”ì‹œì§€ê°€ ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤.');
                }).catch(err => {
                    console.error('ë³µì‚¬ ì‹¤íŒ¨:', err);
                });
                break;
            case 'like-btn':
                // ì¢‹ì•„ìš”/ì‹«ì–´ìš” í† ê¸€
                btn.classList.toggle('liked');
                btn.nextElementSibling.classList.remove('disliked');
                break;
            case 'dislike-btn':
                // ì¢‹ì•„ìš”/ì‹«ì–´ìš” í† ê¸€
                btn.classList.toggle('disliked');
                btn.previousElementSibling.classList.remove('liked');
                break;
            case 'share-btn':
                alert('ê³µìœ  ê¸°ëŠ¥ì€ ì•„ì§ êµ¬í˜„ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.');
                break;
            case 'regenerate-btn':
                // ë§ˆì§€ë§‰ ë´‡ ë©”ì‹œì§€(ì•¡ì…˜ë²„íŠ¼ì„ í¬í•¨í•˜ëŠ”)ë¥¼ ì‚­ì œí•˜ê³  ì¬ìƒì„±
                regenerateResponse(parseInt(index));
                break;
        }
    }
    
    /**
     * ë§ˆì§€ë§‰ ë©”ì‹œì§€ ì¬ìƒì„±
     */
    function regenerateResponse(lastModelIndex) {
        if (isStreaming) return;
        
        // ë´‡ ë©”ì‹œì§€ì™€ ê·¸ ì§ì „ ì‚¬ìš©ì ë©”ì‹œì§€ê¹Œì§€ì˜ ê¸°ë¡ì„ ìœ ì§€
        const startIndex = history.findIndex((msg, i) => msg.role === 'model' && i === lastModelIndex);
        if (startIndex === -1) return; // ë´‡ ë©”ì‹œì§€ê°€ ì•„ë‹Œ ê²½ìš° ì¤‘ë‹¨

        // ë§ˆì§€ë§‰ ì‚¬ìš©ì ë©”ì‹œì§€ê¹Œì§€ì˜ ê¸°ë¡ë§Œ ë‚¨ê¹€ (ë´‡ ë©”ì‹œì§€ëŠ” ì œê±°)
        history.splice(startIndex);
        
        // UIì—ì„œ ë§ˆì§€ë§‰ ë´‡ ë©”ì‹œì§€ ì œê±°
        const lastBotWrapper = document.querySelector(`.bot-message-wrapper[data-message-index="${lastModelIndex}"]`);
        if (lastBotWrapper) {
            lastBotWrapper.remove();
        }
        
        // ë§ˆì§€ë§‰ ì‚¬ìš©ì ë©”ì‹œì§€ contentë¥¼ ê°€ì ¸ì™€ì„œ ì¬ìƒì„± ìš”ì²­
        const lastUserMessage = history[history.length - 1];
        if (lastUserMessage && lastUserMessage.role === 'user') {
            sendMessage(lastUserMessage.content, true); // isRegenerate = true
        }
    }


    function renderMarkdown(rawText) {
        if (!rawText) return "";
        let html = rawText.replace(/\r/g, ''); 
        
        // 1. ë¸”ë¡ ì½”ë“œ ```code```
        html = html.replace(/```([^`]+?)```/gs, (match, content) => {
             return `<pre><code>${content.trim()}</code></pre>`;
        });
        
        // 2. í—¤ë” (#, ##, ###)
        html = html.replace(/^(#+)\s*([^\n]+)/gm, (match, hashes, content) => {
            return `<h${hashes.length}>${content}</h${hashes.length}>`;
        });
        
        // 3. ì¸ë¼ì¸ ì½”ë“œ `code`
        html = html.replace(/`([^`\n]+?)`/g, '<code>$1</code>');

        // 4. êµµì€ ê¸€ì”¨ **text** ë˜ëŠ” __text__
        html = html.replace(/\*\*([^\*]+?)\*\*/g, '<strong>$1</strong>');
        html = html.replace(/__([^__]+?)__/g, '<strong>$1</strong>');
        
        // 5. ë‹¨ì¼ ì¤„ë°”ê¿ˆì„ <br>ë¡œ ë³€í™˜
        html = html.replace(/\n/g, '<br>');
        
        return html;
    }
    
    function updateStreamingDisplay(rawResponse, streamingElement) {
        streamingElement.innerHTML = renderMarkdown(rawResponse);
        chatMessages.scrollTop = chatMessages.scrollHeight;
    }


    function setStreamingState(active) {
        isStreaming = active;
        if (active) {
            sendButton.style.display = 'none';
            stopButton.style.display = 'flex';
            inputField.setAttribute('readonly', 'true');
        } else {
            sendButton.style.display = 'flex';
            stopButton.style.display = 'none';
            inputField.removeAttribute('readonly');
            abortController = null;
        }
        toggleSendButton();
    }
    
    function stopResponse() {
        if (abortController) {
            abortController.abort();
            
            const lastBotMessageWrapper = chatMessages.lastElementChild;
            if (lastBotMessageWrapper) {
                const indicator = lastBotMessageWrapper.querySelector('#thinking-indicator');
                const streamingBlock = lastBotMessageWrapper.querySelector('.streaming-block');

                // ìŠ¤íŠ¸ë¦¬ë°ì„ ì¤‘ì§€í•˜ê³  ìµœì¢… í…ìŠ¤íŠ¸ë¡œ ì—…ë°ì´íŠ¸
                if (indicator) {
                    indicator.remove();
                }
                
                // ë¶ˆì™„ì „í•œ í…ìŠ¤íŠ¸ë¡œ ìµœì¢… ë©”ì‹œì§€ ì €ì¥
                if (streamingBlock && streamingBlock.textContent.trim().length > 0) {
                     // streamingBlockì˜ ë§ˆí¬ë‹¤ìš´ë˜ì§€ ì•Šì€ í…ìŠ¤íŠ¸ë¥¼ historyì— ì €ì¥
                     const rawText = streamingBlock.textContent; 
                     history.push({ role: 'model', content: rawText });
                     saveHistory();
                     
                     // ìµœì¢… UI ì—…ë°ì´íŠ¸ (ì•¡ì…˜ ë²„íŠ¼ í‘œì‹œ)
                     const lastIndex = history.length - 1;
                     const newWrapper = document.createElement('div');
                     newWrapper.className = 'bot-message-wrapper';
                     newWrapper.setAttribute('data-message-index', lastIndex);
                     
                     const finalBotMsg = document.createElement('div');
                     finalBotMsg.className = 'bot-message';
                     finalBotMsg.innerHTML = renderMarkdown(rawText);
                     
                     newWrapper.appendChild(finalBotMsg);
                     newWrapper.appendChild(createActionButtons(rawText, lastIndex));
                     
                     lastBotMessageWrapper.replaceWith(newWrapper);
                } else {
                    // ì•„ë¬´ ë‚´ìš©ë„ ì—†ìœ¼ë©´ ì‚­ì œ
                    lastBotMessageWrapper.remove();
                }
            }
        }
        setStreamingState(false);
    }
    stopButton.addEventListener('click', stopResponse);

    let fullResponse = ""; 

    async function sendMessage(userMsg = null, isRegenerate = false) {
        const userMessage = userMsg !== null ? userMsg : inputField.value.trim();
        if (userMessage.length === 0 || isStreaming) return;

        // 1. ì‚¬ìš©ì ë©”ì‹œì§€ ë²„ë¸” ì¶”ê°€ ë° history ì—…ë°ì´íŠ¸
        if (!isRegenerate) {
            if (initialContent.style.opacity !== '0') {
                initialContent.style.opacity = '0';
                setTimeout(() => {
                    initialContent.style.display = 'none';
                    chatMessages.style.display = 'flex'; 
                }, 500); 
            } else {
                 chatMessages.style.display = 'flex';
            }
            appendUserMessage(userMessage, true); // isNew = true
        }

        // 2. ì…ë ¥ì°½ ì´ˆê¸°í™” ë° UI ìƒíƒœ ì—…ë°ì´íŠ¸
        inputField.value = '';
        inputField.rows = MIN_ROWS; 
        autoResizeTextarea(); 
        
        // 3. ë´‡ ë©”ì‹œì§€ë¥¼ ìœ„í•œ ì»¨í…Œì´ë„ˆ ì¶”ê°€ ë° ë¡œë”© í‘œì‹œ
        const botMessageWrapper = document.createElement('div');
        botMessageWrapper.className = 'bot-message-wrapper';
        
        const indicatorContainer = document.createElement('div');
        indicatorContainer.id = 'thinking-indicator';
        indicatorContainer.innerHTML = `<span class="thinking-indicator-text">ë‹µë³€ì„ ìƒê°í•˜ëŠ” ì¤‘...</span>`;
        
        const streamingBlockElement = document.createElement('div');
        streamingBlockElement.className = 'streaming-block'; 
        
        botMessageWrapper.appendChild(indicatorContainer);
        botMessageWrapper.appendChild(streamingBlockElement);
        chatMessages.appendChild(botMessageWrapper);
        chatMessages.scrollTop = chatMessages.scrollHeight;

        
        // 4. ìŠ¤íŠ¸ë¦¬ë° ìƒíƒœ ì‹œì‘
        setStreamingState(true);
        abortController = new AbortController();
        const signal = abortController.signal;
        
        fullResponse = ""; 
        let buffer = ""; 
        let isFirstChunk = true; 
        
        try {
            const response = await fetch(BACKEND_ENDPOINT, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    message: userMessage,
                    history: history, 
                }),
                signal: signal 
            });

            if (!response.ok) {
                indicatorContainer.remove(); 
                let errorMessage = `HTTP Error: ${response.status} ${response.statusText}`;
                streamingBlockElement.innerHTML = `<p style="color:red;">${errorMessage}</p>`;
                setStreamingState(false);
                
                // ì—ëŸ¬ ë©”ì‹œì§€ë„ íˆìŠ¤í† ë¦¬ì— ì¶”ê°€
                history.push({ role: 'model', content: errorMessage });
                saveHistory();
                
                // ìµœì¢… UI ì—…ë°ì´íŠ¸ (ì•¡ì…˜ ë²„íŠ¼ í‘œì‹œ)
                const lastIndex = history.length - 1;
                botMessageWrapper.setAttribute('data-message-index', lastIndex);
                botMessageWrapper.appendChild(createActionButtons(errorMessage, lastIndex));

                return;
            }

            const reader = response.body.getReader();
            const decoder = new TextDecoder('utf-8');
            
            while (true) {
                const { done, value } = await reader.read();
                if (done) {
                    break;
                }
                
                buffer += decoder.decode(value, { stream: true });
                
                const parts = buffer.split('\n');
                buffer = parts.pop(); 

                for (const part of parts) {
                    const cleanPart = part; 
                    if (cleanPart.trim() === "[DONE]") {
                        fullResponse += buffer;
                        updateStreamingDisplay(fullResponse, streamingBlockElement);
                        
                        setStreamingState(false);
                        const lastIndex = history.length;
                        history.push({ role: 'model', content: fullResponse });
                        saveHistory();
                        
                        // ìµœì¢… UI ì—…ë°ì´íŠ¸ (ë¡œë”© ì œê±° ë° ì•¡ì…˜ ë²„íŠ¼ ì¶”ê°€)
                        indicatorContainer.remove();
                        botMessageWrapper.setAttribute('data-message-index', lastIndex);
                        botMessageWrapper.appendChild(createActionButtons(fullResponse, lastIndex));
                        
                        reader.releaseLock();
                        return; 
                    }
                    
                    if (cleanPart.length > 0) {
                        if (isFirstChunk) {
                            indicatorContainer.remove(); 
                            isFirstChunk = false;
                        }
                        
                        fullResponse += cleanPart + '\n'; 
                        
                        updateStreamingDisplay(fullResponse, streamingBlockElement);
                    }
                }
            }
            
            if (buffer.length > 0) {
                 if (isFirstChunk) {
                    indicatorContainer.remove();
                    isFirstChunk = false;
                 }
                 fullResponse += buffer;
                 updateStreamingDisplay(fullResponse, streamingBlockElement);
            }
            
            // ìŠ¤íŠ¸ë¦¬ë°ì´ ì •ìƒ ì¢…ë£Œëœ í›„
            if (isStreaming) {
                 setStreamingState(false);
                 const lastIndex = history.length;
                 history.push({ role: 'model', content: fullResponse });
                 saveHistory();
                 
                 // ìµœì¢… UI ì—…ë°ì´íŠ¸ (ì•¡ì…˜ ë²„íŠ¼ ì¶”ê°€)
                 indicatorContainer.remove();
                 botMessageWrapper.setAttribute('data-message-index', lastIndex);
                 botMessageWrapper.appendChild(createActionButtons(fullResponse, lastIndex));
            }


        } catch (error) {
            if (error.name === 'AbortError') {
                console.log('Fetch aborted by user or cleanup triggered.');
            } else {
                console.error('Fetch/Streaming Error:', error);
                const errorMsg = `âš ï¸ í†µì‹  ì˜¤ë¥˜: ì„œë²„ì— ì—°ê²°í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤. CORS ì„¤ì • ë˜ëŠ” ì£¼ì†Œë¥¼ í™•ì¸í•´ ì£¼ì„¸ìš”. (Error: ${error.message})`;
                
                indicatorContainer.remove();
                streamingBlockElement.innerHTML = `<p style="color:red;">${errorMsg}</p>`;
                
                // ì—ëŸ¬ ë©”ì‹œì§€ë„ íˆìŠ¤í† ë¦¬ì— ì¶”ê°€
                const lastIndex = history.length;
                history.push({ role: 'model', content: errorMsg });
                saveHistory();

                // ìµœì¢… UI ì—…ë°ì´íŠ¸ (ì•¡ì…˜ ë²„íŠ¼ í‘œì‹œ)
                botMessageWrapper.setAttribute('data-message-index', lastIndex);
                botMessageWrapper.appendChild(createActionButtons(errorMsg, lastIndex));
            }
            setStreamingState(false);
        }
        if(isStreaming) setStreamingState(false);
    }

    sendButton.addEventListener('click', () => sendMessage());

    // ì—”í„°í‚¤ ë™ì‘
    inputField.addEventListener('keydown', (e) => {
        if (e.key === 'Enter') {
            if (isMobile()) {
            } else {
                if (e.shiftKey) {
                    setTimeout(autoResizeTextarea, 0); 
                    return; 
                }
                e.preventDefault(); 
                if (sendButton.classList.contains('active') && !isStreaming) {
                    sendMessage();
                }
            }
        }
    });

    // ğŸŒŸğŸŒŸğŸŒŸ ëª¨ë‹¬ì°½ í† ê¸€ ë¡œì§ ğŸŒŸğŸŒŸğŸŒŸ
    function toggleModal() {
        modalBackdrop.classList.toggle('visible');
    }

    plusButton.addEventListener('click', (e) => {
        e.preventDefault(); 
        toggleModal();
    });
    
    modalBackdrop.addEventListener('click', (e) => {
        if (e.target === modalBackdrop) {
            toggleModal();
        }
    });
    
    // ğŸŒŸğŸŒŸğŸŒŸ ì‚¬ì´ë“œë°” í† ê¸€ ë¡œì§ ğŸŒŸğŸŒŸğŸŒŸ
    function toggleSidebar() {
        if (isMobile()) {
            sidebar.classList.toggle('open');
            menuBackdrop.classList.toggle('visible');
        } 
    }
    function closeSidebar() {
         if (isMobile()) {
            sidebar.classList.remove('open');
            menuBackdrop.classList.remove('visible');
        }
    }

    menuButton.addEventListener('click', toggleSidebar);
    menuBackdrop.addEventListener('click', closeSidebar);
    
    // ìƒˆ ì±„íŒ… ë²„íŠ¼
    document.getElementById('new-chat-btn').addEventListener('click', createNewChat);

    // ì±„íŒ… ê²€ìƒ‰
    chatSearchInput.addEventListener('input', (e) => {
        renderChatList(e.target.value);
    });
    
    // ===============================================
    // ì´ˆê¸°í™” ë° ë¡œë“œ
    // ===============================================

    // ì´ˆê¸° ìƒíƒœ ë†’ì´ ì¡°ì •
    toggleSendButton();
    autoResizeTextarea();
    
    // ğŸŒŸ ëŒ€í™” ë° ì±„íŒ… ëª©ë¡ ë¡œë“œ
    loadChatList();
    loadHistory();
    renderChatList();
    
  </script>
</body>
</html>
